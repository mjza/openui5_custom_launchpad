sap.ui.define(["com/mjzsoft/Mjzsoft0Launchpad/controller/BaseController","com/mjzsoft/Mjzsoft0Launchpad/localService/mockserver","sap/ui/model/json/JSONModel","sap/ushell/iconfonts","sap/ushell/services/AppConfiguration","sap/ui/core/IconPool","sap/m/Button","sap/m/ButtonType","sap/m/Text","sap/m/ActionSheet","sap/m/Dialog","sap/m/DialogType","sap/base/Log"],function(e,t,o,a,s,n,i,r,l,u,h,p,c){"use strict";return e.extend("com.mjzsoft.Mjzsoft0Launchpad.controller.Home",{model:{lang:"en",jwtExpiry:0,counter:null,iTimer:0,sTimer:"00:00",oldPass:undefined,newPass:undefined,confirmNewPass:undefined,error:null},onInit:function(){var e=sap.ui.getCore().getConfiguration().getLanguage();e=e&&e.length>=2?e.substring(0,2):"en";this.model.lang=e;this.setModel(new o(this.model),"launchpadView");a.registerFiori2IconFont();n.addIcon("mjzsoft","customfont","icomoon","e900");var s=window.location.search,i=new URLSearchParams(s);var r=i.get("MjzsoftWithMockServer");if(r==="true"||r==="1"){t.init().then(function(){c.info("Mock server initiated.")});jQuery("#canvas").empty();var l=this._generateLaunchpadContent();l.placeAt("canvas","first")}else{jQuery("#canvas").empty();l=this._generateLaunchpadContent();l.placeAt("canvas","first")}this._readJwtExpiry();sap.ui.getCore().getEventBus().subscribe("JWT","jwtChanged",this._readJwtExpiry,this);this.initJWTObserver();sap.ushell.Container.attachLogoutEvent(this._logout.bind(this))},_readJwtExpiry:function(){var e=this.getOwnerComponent().getJwtAuth().getExpiryTime();this.getModel("launchpadView").setProperty("/jwtExpiry",e)},_generateLaunchpadContent:function(){var e=sap.ushell.Container.createRenderer();e.addStyleClass("sapUShellFullHeight");e.addEventDelegate({onBeforeRendering:this._onBeforeLaunchpadRendering.bind(this),onAfterRendering:this._onAfterLaunchpadRendering.bind(this)},this);return e},_onBeforeLaunchpadRendering:function(e){jQuery("#flowerCanvas").remove()},_onAfterLaunchpadRendering:function(e){var t=this.getModel("i18n");var o=this.getResourceBundle();var a=sap.ushell.Container.getRenderer("fiori2");a.setModel(this.getModel("launchpadView"),"launchpadView");var s=new sap.m.Button({text:o.getText("home_companyName"),icon:"sap-icon://customfont/mjzsoft",press:function(){if(!this._oInfoDialog){this._oInfoDialog=sap.ui.xmlfragment("infoDialog","com.mjzsoft.Mjzsoft0Launchpad.view.dialogs.MjzsoftInfoDialog",this);this._oInfoDialog.setModel(t,"i18n");this._oInfoDialog.open()}else{this._oInfoDialog.open()}}.bind(this)});a.showActionButton([s.getId()],false,["home","app"]);var n=new sap.m.Button({text:o.getText("home_updatePassword"),icon:"sap-icon://two-keys",press:function(){if(!this._oPassUpdateDialog){this._oPassUpdateDialog=sap.ui.xmlfragment("passUpdateDialog","com.mjzsoft.Mjzsoft0Launchpad.view.dialogs.PassUpdateDialog",this);this._oPassUpdateDialog.setModel(t,"i18n");this._oPassUpdateDialog.setModel(this.getModel("launchpadView"),"launchpadView");this._oPassUpdateDialog.open();this.bindOnChangeToInputs("UpdatePass",this._oPassUpdateDialog)}else{var e=this.getModel("launchpadView");e.setProperty("/oldPass",undefined);e.setProperty("/newPass",undefined);e.setProperty("/confirmNewPass",undefined);e.setProperty("/error",null);this.resetAllValueStates();this._oPassUpdateDialog.open()}}.bind(this)});a.showActionButton([n.getId()],false,["home","app"]);var i=a.addHeaderEndItem("sessionTimer",{icon:"sap-icon://fob-watch",floatingNumber:"{launchpadView>/counter}",press:this._showTimerMenu.bind(this)},true,false);i.setModel(this.getModel("launchpadView"),"launchpadView");this._oTimerIcon=i;var r=a.addHeaderEndItem("languageMenu",{icon:"sap-icon://world",tooltip:"{launchpadView>/lang}",press:this._showLanguageMenu.bind(this)},true,false);r.setModel(this.getModel("launchpadView"),"launchpadView");var l=a.addToolAreaItem({icon:"sap-icon://home",tooltip:o.getText("home_startIcon"),expandable:false,press:function(e){var t=window.location.href.split("#")[0]+"#Shell-home";sap.m.URLHelper.redirect(t,false)}},true,false,["app"]);l.setModel(this.getModel("launchpadView"),"launchpadView");var u=sap.ushell.Container.getService("LaunchPage");u.getCatalogs().done(function(e){e.forEach(function(e){e.tiles.forEach(function(e){var t=u.getCatalogTileTargetURL(e),o=u.getCatalogTilePreviewIcon(e),s=u.getCatalogTileTitle(e);if(o&&t){a.addToolAreaItem({icon:o,tooltip:s,expandable:false,press:function(e,t){var o=window.location.href.split("#")[0]+e;sap.m.URLHelper.redirect(o,false)}.bind(this,t)},true,false,["home","app"])}})})})},_showLanguageMenu:function(e){var t=e.getSource();if(!this._oLanguageMenu){this._oLanguageMenu=this._createLanguageMenu()}if(this._oLanguageMenu.isOpen()){this._oLanguageMenu.close()}else{this._oLanguageMenu.openBy(t)}},_createLanguageMenu:function(){var e=new i({text:"{languages>name}",textDirection:{path:"languages>rtl",formatter:function(e){return e?sap.ui.core.TextDirection.RTL:sap.ui.core.TextDirection.LTR}},type:{path:"languages>id",formatter:function(e){var t=sap.ui.getCore().getConfiguration().getLanguage();t=t&&t.length>=2?t.substring(0,2):"en";return t===e?r.Accept:r.Default}},customData:[{Type:"sap.ui.core.CustomData",key:"lang",value:"{languages>id}"},{Type:"sap.ui.core.CustomData",key:"rtl",value:"{languages>rtl}"}],press:function(e){sap.ui.core.BusyIndicator.show(1);var t=e.getSource().data("lang");var o=""+window.location.href,a=o;var s=/([?&]sap-language)=([^#&]*)/g;var n=s.exec(o);if(n&&n.length>0){a=o.replace(s,n[1]+"="+t)}else if(o.indexOf("?")>0){a=o.replace("?","?sap-language="+t+"&")}else{a=o.replace(".html",".html?sap-language="+t+"&")}sap.m.URLHelper.redirect(a,false)}});var t=new u({showCancelButton:false,buttons:{path:"languages>/",template:e,templateShareable:false}});t.setModel(this.getModel("languages"),"languages");return t},_showTimerMenu:function(e){var t=e.getSource();if(!this._oTimerMenu){this._oTimerMenu=this._createTimerMenu()}if(this._oTimerMenu.isOpen()){this._oTimerMenu.close()}else{this._oTimerMenu.openBy(t)}},_createTimerMenu:function(){var e=new i({icon:"sap-icon://fob-watch",text:"{launchpadView>/sTimer}",type:r.Transparent,enabled:false,customData:[{Type:"sap.ui.core.CustomData",key:"timer",value:{path:"launchpadView>/iTimer",formatter:function(e){if(e&&e>864e5){return"Blue"}else if(e&&e>36e5){return"Green"}else if(e&&e>6e4){return"Yellow"}return"Red"}},writeToDom:true}]});e.addStyleClass("mjzsoftTimerBtn");e.setModel(this.getModel("launchpadView"),"launchpadView");var t=new u({showCancelButton:false,buttons:[e]});t.setModel(this.getModel("launchpadView"),"launchpadView");return t},initJWTObserver:function(){var e=setInterval(function(){var t=this.getModel("launchpadView");var o=(new Date).getTime();var a=t.getProperty("/jwtExpiry");var s=a-o;t.setProperty("/iTimer",s);if(s<0){clearInterval(e);t.setProperty("/counter",null);sap.ui.core.BusyIndicator.show(1);location.reload();return}var n=Math.floor(s/864e5);var i=Math.floor(s%864e5/36e5);var r=Math.floor(s%36e5/6e4);var l=Math.floor(s%6e4/1e3);var u="";var h=this.getResourceBundle().getText("home_days");u+=n>0?n+" "+h+", ":"";u+=i>9?""+i:"0"+i;u+=":";u+=r>9?""+r:"0"+r;u+=":";u+=l>9?""+l:"0"+l;if(n>0&&t.getProperty("/counter")!==n){t.setProperty("/counter",n);this._oTimerIcon.addStyleClass("mjzsoftBlueCounter")}else if(n<=0&&i>0&&t.getProperty("/counter")!==i){t.setProperty("/counter",i);this._oTimerIcon.removeStyleClass("mjzsoftBlueCounter");this._oTimerIcon.addStyleClass("mjzsoftGreenCounter")}else if(n<=0&&i<=0&&r>0&&t.getProperty("/counter")!==r){t.setProperty("/counter",r);this._oTimerIcon.removeStyleClass("mjzsoftBlueCounter");this._oTimerIcon.removeStyleClass("mjzsoftGreenCounter");this._oTimerIcon.addStyleClass("mjzsoftYellowCounter")}else if(n<=0&&i<=0&&r<=0&&l>0&&t.getProperty("/counter")!==l){t.setProperty("/counter",l);this._oTimerIcon.removeStyleClass("mjzsoftBlueCounter");this._oTimerIcon.removeStyleClass("mjzsoftGreenCounter");this._oTimerIcon.removeStyleClass("mjzsoftYellowCounter");t.setProperty("/sessionDialogText",this.getResourceBundle().getText("home_sessionMustRefresh",l));this._showJwtRefreshAlert()}t.setProperty("/sTimer",u)}.bind(this),1e3)},_showJwtRefreshAlert:function(){if(!this._oSessionDialog){var e=new h({title:this.getResourceBundle().getText("home_warning"),type:p.Message,state:sap.ui.core.ValueState.Warning,content:new l({text:"{launchpadView>/sessionDialogText}"}),beginButton:new i({type:r.Emphasized,text:this.getResourceBundle().getText("home_refresh"),press:function(){this.getOwnerComponent().getJwtAuth().refreshToken();e.close()}.bind(this)}),endButton:new i({type:r.Negative,text:this.getResourceBundle().getText("home_signout"),press:function(){this.getOwnerComponent().getJwtAuth().signOut();e.close()}.bind(this)}),afterClose:function(){this._oSessionDialog=undefined;e.destroy()}.bind(this)});e.setModel(this.getModel("launchpadView"),"launchpadView");this._oSessionDialog=e}if(!this._oSessionDialog.isOpen()){this._oSessionDialog.open()}},_logout:function(){this.getOwnerComponent().getJwtAuth().signOut()},dialogPassUpdateSubmitBtnPress:function(e){var t=this.getModel("launchpadView"),o=t.getProperty("/oldPass"),a=t.getProperty("/newPass"),s=sap.ui.core.Fragment.byId("passUpdateDialog","confirmNewPassInput");if(!this.areFieldsValid("UpdatePass",this._oPassUpdateDialog)){return}if(!t.getProperty("/passConfirmed")){s.setValueState(sap.ui.core.ValueState.Error);return}s.setValueState(sap.ui.core.ValueState.None);this._oPassUpdateDialog.setBusy(true);this.getOwnerComponent().getJwtAuth().updatePassword(o,a,function(e,t,o){this._oPassUpdateDialog.setBusy(false);this._oPassUpdateDialog.close();this._logout()}.bind(this),function(e,o,a){this._oPassUpdateDialog.setBusy(false);var s=this.extractErrorMessage(e,o,a);t.setProperty("/error",s)}.bind(this))},dialogCloseBtnPress:function(e){if(this._oInfoDialog){this._oInfoDialog.close()}if(this._oPassUpdateDialog){this._oPassUpdateDialog.close()}},onConfirmPassChanged:function(e){var t=this.getModel("launchpadView"),o=t.getProperty("/newPass"),a=t.getProperty("/confirmNewPass");if(o!==a){t.setProperty("/passConfirmed",false)}else{t.setProperty("/passConfirmed",true)}},onErrorStripClosed:function(e){this.getViewModel().setProperty("/error",null)}})});