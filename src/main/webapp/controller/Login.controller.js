sap.ui.define(["com/mjzsoft/Mjzsoft0Launchpad/controller/BaseController","sap/ui/model/json/JSONModel","sap/m/MessageToast"],function(e,t,r){"use strict";return e.extend("com.mjzsoft.Mjzsoft0Launchpad.controller.Login",{model:{firstname:"",lastname:"",email:"",user:"",pass:"",confirmPass:"",passConfirmed:false,flow:"login",success:null,error:null,lang:"en",captchaText:"",captcha:"",result:0,emailInUse:false},onInit:function(){var e=this.getOwnerComponent().getTargets();this.getOwnerComponent().getJwtAuth().hasSession(function(t){if(t){e.display("TargetHome");return}});var r=sap.ui.getCore().getConfiguration().getLanguage();r=r&&r.length>=2?r.substring(0,2):"en";this.model.lang=r;this.setModel(new t(this.model),"loginView");this.initiateValidator()},onBeforeRendering:function(t){e.prototype.onBeforeRendering(t)},onAfterRendering:function(t){e.prototype.onAfterRendering(t);this.bindOnChangeToInputs("Login");this.bindOnChangeToInputs("Register");this.bindOnChangeToInputs("Reset");this.getValidator().removeAllMessages()},getViewModel:function(){return this.getModel("loginView")},onChangeViewPress:function(e){var t=e.getSource();var r=t.data("key");var s=this.getViewModel();s.setProperty("/success",null);s.setProperty("/error",null);s.setProperty("/emailInUse",false);s.setProperty("/email",null);s.setProperty("/user",null);s.setProperty("/pass",null);s.setProperty("/confirmPass",null);s.setProperty("/passConfirmed",false);s.setProperty("/result",0);if(r==="login"){s.setProperty("/flow",r)}else if(r==="register"){this._newCaptcha();s.setProperty("/flow",r)}else if(r==="reset"){this._newCaptcha();s.setProperty("/flow",r)}},onLanguageChange:function(e){sap.ui.getCore().getEventBus().publish("App","StartAppBusy",null);var t=e.getSource().getSelectedKey();var r=""+window.location.href,s=r;var o=/([?&]sap-language)=([^#&]*)/g;var n=o.exec(r);if(n&&n.length>0){s=r.replace(o,n[1]+"="+t)}else if(r.indexOf("?")>0){s=r.replace("?","?sap-language="+t+"&")}else{s=r.replace("index.html","index.html?sap-language="+t+"&")}sap.m.URLHelper.redirect(s,false)},onLoginButtonPress:function(){if(!this.areFieldsValid("Login")){return}var e=this.getViewModel();var t=this.getOwnerComponent().getTargets();sap.ui.getCore().getEventBus().publish("App","StartAppBusy",null);e.setProperty("/success",null);e.setProperty("/error",null);this.getOwnerComponent().getJwtAuth().signIn(e.getProperty("/user"),e.getProperty("/pass"),function(e,r,s){sap.ui.getCore().getEventBus().publish("App","StopAppBusy",null);this.getModel().setHeaders({Authorization:this.getOwnerComponent().getJwtAuth().getJwt()});sap.ui.getCore().getEventBus().publish("App","StartAppBusy",null);t.display("TargetHome")}.bind(this),function(t,r,s){sap.ui.getCore().getEventBus().publish("App","StopAppBusy",null);var o=this.extractErrorMessage(t,r,s);e.setProperty("/error",o)}.bind(this))},onRegisterButtonPress:function(){var e=this.getViewModel(),t=this.getView().byId("confirmPass");if(!this.areFieldsValid("Register")||!this._checkCaptcha()){return}if(e.getProperty("/emailInUse")){t=this.getView().byId("register_email");t.setValueState("Error");var r=this.getResourceBundle().getText("login_errorEmailInUse");e.setProperty("/error",r);return}if(!e.getProperty("/passConfirmed")){t.setValueState(sap.ui.core.ValueState.Error);return}t.setValueState(sap.ui.core.ValueState.None);sap.ui.getCore().getEventBus().publish("App","StartAppBusy",null);e.setProperty("/success",null);e.setProperty("/error",null);this.getOwnerComponent().getJwtAuth().register(e.getProperty("/firstname"),e.getProperty("/lastname"),e.getProperty("/email"),e.getProperty("/pass"),function(t,r,s){sap.ui.getCore().getEventBus().publish("App","StopAppBusy",null);e.setProperty("/success",t.data);e.setProperty("/flow","login")}.bind(this),function(t,s,o){sap.ui.getCore().getEventBus().publish("App","StopAppBusy",null);r=this.extractErrorMessage(t,s,o);e.setProperty("/error",r)}.bind(this))},onResetButtonPress:function(){if(!this.areFieldsValid("Reset")||!this._checkCaptcha()){return}var e=this.getViewModel();sap.ui.getCore().getEventBus().publish("App","StartAppBusy",null);e.setProperty("/success",null);e.setProperty("/error",null);this.getOwnerComponent().getJwtAuth().forgetPassword(e.getProperty("/email"),function(t,r,s){sap.ui.getCore().getEventBus().publish("App","StopAppBusy",null);e.setProperty("/success",this.getResourceBundle().getText("login_forgetPassword"));e.setProperty("/flow","login")}.bind(this),function(t,r,s){sap.ui.getCore().getEventBus().publish("App","StopAppBusy",null);var o=this.extractErrorMessage(t,r,s);e.setProperty("/error",o)}.bind(this))},_checkCaptcha:function(){function e(e,t){var r=parseInt(e,t);if(isNaN(r)){return 0}return r}var t=this.getViewModel();if(e(t.getProperty("/captcha"),10)!==t.getProperty("/result")){t.setProperty("/error",this.getResourceBundle().getText("login_errorCaptcha"));this._newCaptcha();return false}return true},_newCaptcha:function(){var e=this.getViewModel();var t=function(e,t){return Math.floor(Math.random()*(t-e+1))+e};var r=t(2,4);var s=t(1,9),o=""+s;for(var n=1;n<r;n++){var i=t(1,9),a=t(0,1);if(a===0){s+=i;o+=" + "+i}else{s-=i;o+=" - "+i}}e.setProperty("/captchaText",this.getResourceBundle().getText("login_captcha",o));e.setProperty("/captcha","");e.setProperty("/result",s)},onSuccessStripClosed:function(e){var t=this.getViewModel();t.setProperty("/success",null)},onErrorStripClosed:function(e){var t=this.getViewModel();t.setProperty("/error",null)},onRejectButtonPress:function(){var e=this.getViewModel();e.setProperty("/success",null);e.setProperty("/error",null);e.setProperty("/flow","login")},onEmailChanged:function(e){var t=this.getViewModel();var r=e.getSource(),s=r.getValue();r.setBusy(true);t.setProperty("/emailInUse",false);this.getOwnerComponent().getJwtAuth().checkEmailInUse(s,function(e,s,o){r.setBusy(false);if(e.data==="true"){var n=this.getResourceBundle().getText("login_errorEmailInUse");t.setProperty("/error",n);t.setProperty("/emailInUse",true);r.setValueState(sap.ui.core.ValueState.Error)}else{r.setValueState(sap.ui.core.ValueState.None);t.setProperty("/emailInUse",false);t.setProperty("/error",null)}}.bind(this),function(e,t,s){r.setBusy(false)}.bind(this))},onConfirmPassChanged:function(e){var t=this.getViewModel(),r=t.getProperty("/pass"),s=t.getProperty("/confirmPass");if(r!==s){t.setProperty("/passConfirmed",false)}else{t.setProperty("/passConfirmed",true)}}})});