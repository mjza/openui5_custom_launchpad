sap.ui.define(["sap/ui/base/Object","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/json/JSONModel"],function(e,t,a,s){"use strict";return e.extend("com.mjzsoft.QuestionnaireBuilder.model.JsonModelManager",{sModelName:"",sModelPath:"",constructor:function(e,t,a){this.sModelName=e;this.sModelPath=t;this._aMiddlewareChangeLog={};this._aMiddlewareChangeLog[e]={aDeletedItems:[],aUpdatedItems:[],aCreatedItems:[],fnComparator:a}},createModel:function(e){this._aOriginalData=[];var t={};var a=new s(t);t[this.sModelPath]=[];this._aOriginalData[this.sModelName]=jQuery.extend(true,[],t[this.sModelPath]);e.getView().setModel(a,this.sModelName)},getModelName:function(){return this.sModelName},_setData:function(e,t){var a={};a[this.sModelPath]=t;this._aOriginalData[this.sModelName]=jQuery.extend(true,[],a);e.getView().getModel(this.sModelName).setData(a)},updateData:function(e,t,a){if(a){this.resetChanges(e);this._setData(e,[])}else{var s=[];if(t){if(Array.isArray(t)){s=t}else{s.push(t)}}var r=e.getView().getModel();var i="/"+this.sModelPath;r.read(i,{filters:s,success:function(t,a){this.resetChanges(e);this._setData(e,t.results)}.bind(this)})}},resetChanges:function(e){e.getView().getModel(this.sModelName).setData(this._aOriginalData[this.sModelName]);this._aMiddlewareChangeLog[this.sModelName]={aDeletedItems:[],aUpdatedItems:[],aCreatedItems:[],fnComparator:this._aMiddlewareChangeLog[this.sModelName].fnComparator}},addToMiddlewareJsonModel:function(e,t){var a=e.getView().getModel(this.sModelName).getData();if(a[this.sModelPath].length>0){a[this.sModelPath]=a[this.sModelPath].concat(t)}else{a[this.sModelPath]=t}this._updateMiddlewareLog(this.sModelName,"Create",t);e.getView().getModel(this.sModelName).setData(a);e.getView().getModel(this.sModelName).refresh(true)},updateEntry:function(e){if(parseInt(e.Id,10)>0){this._updateMiddlewareLog(this.sModelName,"Update",[e])}},deleteFromJsonModel:function(e,t){var a=t.getSelectedContexts();var s=[];for(var r=0;r<a.length;r++){var i=a[r].getObject();s.push(i)}var o=jQuery.extend(true,[],this._getCurrentElemets(e));for(var d=0;d<s.length;d++){var l=s[d];for(var h=0;h<o.length;h++){var n=o[h];if(this._aMiddlewareChangeLog[this.sModelName].fnComparator(l,n)===true){o.splice(h,1);this._updateMiddlewareLog(this.sModelName,"Delete",[l]);break}}}t.removeSelections();var g={};g[this.sModelPath]=o;e.getView().getModel(this.sModelName).setData(g);e.getView().getModel(this.sModelName).refresh(true)},deleteItemsFromModel:function(e,t){var a=jQuery.extend(true,[],this._getCurrentElemets(e));for(var s=0;s<t.length;s++){var r=t[s];for(var i=0;i<a.length;i++){var o=a[i];if(this._aMiddlewareChangeLog[this.sModelName].fnComparator(r,o)===true){a.splice(i,1);this._updateMiddlewareLog(this.sModelName,"Delete",[r]);break}}}var d={};d[this.sModelPath]=a;e.getView().getModel(this.sModelName).setData(d);e.getView().getModel(this.sModelName).refresh(true)},_updateMiddlewareLog:function(e,t,a){var s=this._aMiddlewareChangeLog[e].aDeletedItems,r=this._aMiddlewareChangeLog[e].aUpdatedItems,i=this._aMiddlewareChangeLog[e].aCreatedItems,o=this._aMiddlewareChangeLog[e].fnComparator;for(var d=0;d<a.length;d++){var l=this._removeObjFromArray(a[d],i,o),h=this._removeObjFromArray(a[d],r,o),n=this._removeObjFromArray(a[d],s,o);if(t==="Delete"){if(l){continue}else{s.push(a[d])}}else if(t==="Update"){if(l){i.push(a[d])}else{r.push(a[d])}}else if(t==="Create"){if(h||n){r.push(a[d])}else{i.push(a[d])}}}},_removeObjFromArray:function(e,t,a){for(var s=0;s<t.length;s++){if(typeof a==="function"){if(a(e,t[s])===true){t.splice(s,1);return true}}}return false},_getCurrentElemets:function(e){var t=e.getView().getModel(this.sModelName).getData();return t[this.sModelPath]},getDeletedItems:function(){return this._aMiddlewareChangeLog[this.sModelName].aDeletedItems},getUpdatedItems:function(){return this._aMiddlewareChangeLog[this.sModelName].aUpdatedItems},getCreatedItems:function(){return this._aMiddlewareChangeLog[this.sModelName].aCreatedItems}})});