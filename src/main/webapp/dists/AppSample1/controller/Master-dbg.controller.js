sap.ui.define(["./BaseController","../utils/Utils","../model/formatter","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/Device","sap/m/MessageToast","../model/individualFormatter"],function(e,t,r,o,s,i,a,n){"use strict";return e.extend("com.mjzsoft.QuestionnaireBuilder.controller.Master",{formatter:r,onInit:function(){this.setModel(this._initViewModel(),"masterView");this.initiateValidator();var e=sap.ui.getCore().getEventBus();e.subscribe("_formChange",this._onFormChange,this);e.subscribe("_refreshMasterSelection","formId",this._refreshMasterSelection,this);e.subscribe("_deselectMasterSelection","detailClose",this._deselectMasterSelection,this);this.getRouter().getRoute("master").attachMatched(this._onMasterMatched,this)},onAfterRendering:function(e){this.bindOnChangeToInputs("fieldGroupItem");this.getValidator().removeAllMessages()},onExit:function(){var e=sap.ui.getCore().getEventBus();e.unsubscribe("_refreshMasterSelection","formId",this._refreshMasterSelection,this);e.unsubscribe("_deselectMasterSelection","detailClose",this._deselectMasterSelection,this)},_initViewModel:function(){return new o({delay:0,masterCounterTitle:"...",showNoDataMessage:false,groupBy:"None",busy:false,allResources:"",enableDelete:false,selectedItem:null})},_onMasterMatched:function(e){if(!this.getOwnerComponent().getCurrentUser()||!this.getOwnerComponent().getCurrentUser().admin){this.getRouter().navTo("notAllowed",{},true);this.getModel("appView").setProperty("/layout","OneColumn")}else{var t=this.getAppViewModel();t.setProperty("/flexBoxDirection","Row");t.setProperty("/layout","OneColumn");t.setProperty("/datesChanged",false);this._deselectMasterSelection()}},_onFormChange:function(e,t,r){var o=this.getView().byId("flexboxId");o.getBinding("items").attachEventOnce("dataReceived",function(){var e=o.getItems();this._setSelectedItem(e,r.formId)}.bind(this));o.getBinding("items").refresh();sap.ui.getCore().getEventBus().unsubscribe("_refreshMasterSelection","formId",this._refreshMasterSelection,this)},_refreshMasterSelection:function(e,t,r){var o=this.getView().byId("flexboxId");var s=o.getItems();if(s.length===0){o.getBinding("items").attachEventOnce("dataReceived",function(){s=o.getItems();this._setSelectedItem(s,r.formId)}.bind(this))}else{this._setSelectedItem(s,r.formId)}sap.ui.getCore().getEventBus().unsubscribe("_refreshMasterSelection","formId",this._refreshMasterSelection,this)},_setSelectedItem:function(e,t){var r=e.find(function(e){var r=e.getBindingContext().sPath;var o=this.getView().getModel().getProperty(r);return o.Id===t}.bind(this));if(r){this._selectMasterSelection(r)}else{var o=this.getAppViewModel();o.setProperty("/flexBoxDirection","Row");o.setProperty("/layout","OneColumn");o.setProperty("/datesChanged",false)}},_deselectMasterSelection:function(){var e=this.getView().byId("flexboxId");var t=e.getItems();t.forEach(function(e){e.removeStyleClass("mjzsoftSelectedTileItem")});var r=this.getModel("masterView");r.setProperty("/enableDelete",false);r.setProperty("/selectedItem",null)},_selectMasterSelection:function(e){e.addStyleClass("mjzsoftSelectedTileItem");this._scrollToSelectedTile(e);var t=this.getModel("masterView");t.setProperty("/enableDelete",true);t.setProperty("/selectedItem",e)},_scrollToSelectedTile:function(e){var t=this.getView().byId("masterScrollContainer");setTimeout(function(e,t){try{e.scrollToElement(t)}catch(e){}}.bind(this,t,e),10)},_showDetail:function(e){var t=!a.system.phone;var r=this.getAppViewModel();r.setProperty("/layout","TwoColumnsMidExpanded");this.getRouter().navTo("object",{objectId:e.getBindingContext().getProperty("Id")},t)},_applyFilterSearch:function(e){this.getRouter().navTo("master",{},true);var t=[];if(e&&e.length>0){t=e}var r=this.getView().byId("flexboxId");r.getBinding("items").filter(t)},_applyFilterSearchIcons:function(e){var t=[];if(e&&e.length>0){t=e}var r=sap.ui.getCore().byId("iconDialog");r.getBinding("items").filter(t)},onFormsReceived:function(e){var t=e.getSource(),r=this.getModel("masterView");r.setProperty("/masterCounterTitle",this.getResourceBundle().getText("TxtNumberResources",[t.getLength()]));if(t.getLength()===0){r.setProperty("/showNoDataMessage",true)}else{r.setProperty("/showNoDataMessage",false)}},onSearch:function(e){if(e.getParameters().refreshButtonPressed){this.onRefresh();return}var t=[];var r=e.getParameter("query");if(r){t.push(new s("Name",i.Contains,r))}this._applyFilterSearch(t)},onSearchLiveChange:function(e){if(e.getParameters().newValue.length===0){this.onSearch(e)}},onRefresh:function(){var e=this.getView().byId("flexboxId");e.getBinding("items").refresh()},onPressItem:function(e){if(this.getView().getModel("appView").getProperty("/editMode")){n.show(this.getResourceBundle().getText("MsgEditStateOn"))}else{var t=!a.system.phone;var r=e.getSource();var o=r.getBindingContext().sPath;this._deselectMasterSelection();this._selectMasterSelection(r);var s=this.getAppViewModel();s.setProperty("/flexBoxDirection","Column");s.setProperty("/layout","TwoColumnsMidExpanded");var i=this.getModel().getProperty(o);this.getRouter().navTo("object",{objectId:i.Id},t)}},onCreateFromBtnPress:function(e){if(!this._oCreateFormDialog){this._oCreateFormDialog=sap.ui.xmlfragment("com.mjzsoft.QuestionnaireBuilder.view.fragment.AddForm",this);this.getView().addDependent(this._oCreateFormDialog)}var t=new o;t.setData({IconId:"IC1",IconSrc:"sap-icon://building"});this._oCreateFormDialog.setModel(t,"oFragViewModel");sap.ui.getCore().byId("SaveBtnId").setEnabled(false);this._oCreateFormDialog.getModel("appView").setProperty("/viewIcon",true);this._oCreateFormDialog.getModel("appView").setProperty("/CreateEditSurveyTitle",this.getResourceBundle().getText("CreateNewSurveyTitle"));this._oCreateFormDialog.open()},onDeleteFromBtnPress:function(e){var r=this.getModel("masterView");var o=r.getProperty("/selectedItem");if(o){var s=this.getModel().getProperty(o.getBindingContext().sPath);var i=this.getResourceBundle();t.showDialog(this,i.getText("masterTitDeleteForm"),i.getText("masterSureDeleteForm",[s.Name]),this.onDeleteForm.bind(this),true,undefined,i.getText("BtnNo"),i.getText("BtnYes"))}},onDeleteForm:function(){var e=this.getModel("masterView");var t=e.getProperty("/selectedItem");if(t){var r=this.getModel();var o=t.getBindingContext().sPath;var s=r.getProperty(o);var i="mjzsoft_update_"+(new Date).getTime();r.setDeferredGroups([i]);s.Deleted=true;s=this.getBatchObject(s,"Form");r.update(o,s,{groupId:i});r.submitChanges({groupId:i,success:function(){r.setDeferredGroups([]);n.show(this.getResourceBundle().getText("MsgSuccessDelete"));this.getView().byId("flexboxId").getBinding("items").refresh(true);var t=this.getAppViewModel();t.setProperty("/flexBoxDirection","Row");t.setProperty("/layout","OneColumn");e.setProperty("/enableDelete",false)}.bind(this),error:function(){r.setDeferredGroups([])}})}},onCancelForm:function(){this.getAppViewModel().setProperty("/datesChanged",false);if(this._oCreateFormDialog&&this._oCreateFormDialog.isOpen()){this._oCreateFormDialog.close()}},onSaveForm:function(e){var t=this.getAppViewModel();t.setProperty("/datesChanged",false);this.getModel("masterView").setProperty("/busy",true);var r=sap.ui.core.format.DateFormat.getDateTimeInstance();var o=this._oCreateFormDialog.getModel("oFragViewModel").getData();o=this.getBatchObject(o,"Form");o.ValidFrom=r.parse(sap.ui.getCore().byId("startDateTime").getValue());o.ValidTo=r.parse(sap.ui.getCore().byId("endDateTime").getValue());var s=this.getModel();s.setUseBatch(true);s.create("/FormSet",o,{success:function(e,r){this.getModel("masterView").setProperty("/busy",false);n.show(this.getResourceBundle().getText("MsgToastSuccess"));this._oCreateFormDialog.close();t.setProperty("/flexBoxDirection","Column");t.setProperty("/layout","TwoColumnsMidExpanded");this.getRouter().navTo("object",{objectId:e.Id});var o=this.getView().byId("flexboxId");o.getBinding("items").attachEventOnce("dataReceived",function(){var t=o.getItems();this._setSelectedItem(t,e.Id)}.bind(this));this.onRefresh()}.bind(this),error:function(e){this.getModel("masterView").setProperty("/busy",false);n.show(this.getResourceBundle().getText("MsgToastError"));this._oCreateFormDialog.close()}.bind(this)})},onAfterCloseDialog:function(){if(this._oCreateFormDialog){this._oCreateFormDialog.destroy();this._oCreateFormDialog=null}},onStartDateChange:function(e){this.getAppViewModel().setProperty("/datesChanged",true);this.getValidator().validate(sap.ui.getCore().byId("startDateTime"));this.createFormInputsValidation()},onEndDateChange:function(e){this.getAppViewModel().setProperty("/datesChanged",true);this.createFormInputsValidation()},onSwitchChange:function(e){var t=e.getSource().getBindingContext();var r=t.getModel();var o=t.getPath()+"/Universal";r.setProperty(o,e.getSource().getState())},createFormInputsValidation:function(){var e=sap.ui.getCore().byId("startDateTime"),t=sap.ui.getCore().byId("endDateTime"),r=sap.ui.getCore().byId("titleId").getValue();if(r.length===0||e.getValue().length===0||e.getValueState()==="Error"||t.getValue().length===0||t.getValueState()==="Error"){sap.ui.getCore().byId("SaveBtnId").setEnabled(false)}else{sap.ui.getCore().byId("SaveBtnId").setEnabled(true)}},onCreateFormTitleLiveChange:function(e){this.createFormInputsValidation()},onIconPress:function(e){if(!this._IconSelectorDialog){this._IconSelectorDialog=sap.ui.xmlfragment("com.mjzsoft.QuestionnaireBuilder.view.fragment.DialogIconSelector",this);this.getView().addDependent(this._IconSelectorDialog);this._IconSelectorDialog.setModel(this.getView().getModel())}this._IconSelectorDialog.open()},handleCloseIcon:function(e){var t=e.getParameter("selectedContexts");if(t.length>0){this._oCreateFormDialog.getModel("oFragViewModel").setProperty("/IconSrc",t[0].getObject().Source);this._oCreateFormDialog.getModel("oFragViewModel").setProperty("/IconId",t[0].getObject().Id)}},onRefreshIcons:function(){var e=this.getView().byId("flexboxId");e.getBinding("items").refresh()},handleSearchIcon:function(e){if(e.getParameters().refreshButtonPressed){this.onRefreshIcons();return}var t=[];var r=e.getParameter("value");if(r){t.push(new s("Name",i.Contains,r))}this._applyFilterSearchIcons(t)},liveSearchIcon:function(e){if(e.getParameter("value").length===0){this.handleSearchIcon(e)}}})});