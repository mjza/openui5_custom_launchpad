sap.ui.define(["./BaseController","../utils/Utils","../model/formatter","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageToast","sap/m/MessageBox","sap/ui/core/Fragment","../model/JsonModelManager"],function(e,t,i,s,o,r,n,a,d,g){"use strict";return e.extend("com.mjzsoft.QuestionnaireBuilder.controller.ObjectDetail",{formatter:i,onInit:function(){var e=this._initViewModel();this.setModel(e,"objectDetailView");this.getRouter().getRoute("objectDetail").attachBeforeMatched(this._onBeforeMatched,this);this.getRouter().getRoute("objectDetail").attachPatternMatched(this._onObjectMatched,this);this.getRouter().getRoute("createObject").attachBeforeMatched(this._onBeforeMatched,this);this.getRouter().getRoute("createObject").attachPatternMatched(this._onCreateObjectMatched,this);this.initiateValidator();this._oValidator=this.getValidator();this._oValidator.removeAllMessages();this._iNextId=-1;this._oOptionsManager=new g("ObjectOptionsModel","OptionSet",this.getOptionsComparator);this._oOptionsManager.createModel(this)},onAfterRendering:function(e){this.bindOnChangeToInputs("fieldGroupItem")},onPressCloseObjectPage:function(e){sap.ui.getCore().getEventBus().publish("_deselectDetailSelection","objectDetailClose",{});if(this.getView().getModel("objectDetailView").getProperty("/editMode")){var i=this.getModel().hasPendingChanges();var s=this.getResourceBundle();var o=this._oOptionsManager.getDeletedItems(),r=this._oOptionsManager.getUpdatedItems(),n=this._oOptionsManager.getCreatedItems();if(i||o.length>0||r.length>0||n.length>0){t.showDialog(this,s.getText("TitDialogClose"),s.getText("closeViewInEditMode"),this.onCloseView.bind(this),true,undefined,"","")}else{this.onCloseView()}}else{this._navFromDetailObjectToDetail()}},onPressEdit:function(e){this._oValidator=this.getValidator();this._oValidator.removeAllMessages();var t=this.getView().getModel("objectDetailView");t.setProperty("/editMode",true);this.getModel("appView").setProperty("/editMode",true);t.setProperty("/createMode",false);var i=this.getView().byId("questionTypeSelectId");if(i.getSelectedKey()==="QT3"||i.getSelectedKey()==="QT4"||i.getSelectedKey()==="QT7"){t.setProperty("/tableEditMode",true)}else{t.setProperty("/tableEditMode",false)}},onPressSaveEdit:function(e){var i=this.getModel().hasPendingChanges();var s=this.getResourceBundle();var o=this._oOptionsManager.getDeletedItems(),r=this._oOptionsManager.getUpdatedItems(),n=this._oOptionsManager.getCreatedItems();if(i||o.length>0||r.length>0||n.length>0){if(this._oValidator.validate(this.byId("objectDetailFormId"))&&this._oValidator.validate(this.byId("tableAnswers"))){if(this.checkAnswers()){if(this._checkQuestionRequirements()){t.showDialog(this,s.getText("saveMsg"),s.getText("saveBtnMsg"),this.onSaveDialog.bind(this),true,undefined,s.getText("BtnNo"),s.getText("BtnYes"))}else{a.show(s.getText("atleastTwoPossibleAnswersError"),{icon:a.Icon.ERROR,title:s.getText("errorHeader"),actions:[a.Action.OK],onClose:function(e){}})}}else{a.show(s.getText("MsgToastOptionsEmpty"),{icon:a.Icon.ERROR,title:s.getText("errorHeader"),actions:[a.Action.OK],onClose:function(e){}})}}}else{var d=this.getView().getModel("objectDetailView");d.setProperty("/editMode",false);this.getModel("appView").setProperty("/editMode",false);d.setProperty("/tableEditMode",false);var g=this.getView().byId("tableAnswers");g.removeSelections()}},onPressCancel:function(e){var i=this.getResourceBundle();var s=this.getModel().hasPendingChanges();var o=this._oOptionsManager.getDeletedItems(),r=this._oOptionsManager.getUpdatedItems(),n=this._oOptionsManager.getCreatedItems();if(this.getView().getModel("objectDetailView").getProperty("/showAdd")===true){if(s||o.length>0||r.length>0||n.length>0){t.showDialog(this,i.getText("TitDialogCancel"),i.getText("TxtDialogCancel"),this.onCancelNewItem.bind(this),true,undefined,"","")}else{this.onCancelNewItem()}}else{if(s||o.length>0||r.length>0||n.length>0){t.showDialog(this,i.getText("TitDialogCancel"),i.getText("TxtDialogCancel"),this.onCancelItemEdit.bind(this),true,undefined,i.getText("BtnNo"),i.getText("BtnYes"))}else{this.onCancelItemEdit()}}},onQuestionTypeSelectChange:function(e){var t=e.getSource();if(t.getSelectedKey()==="QT4"||t.getSelectedKey()==="QT3"||t.getSelectedKey()==="QT7"){this.getView().getModel("objectDetailView").setProperty("/tableEditMode",true);this.getView().getModel("objectDetailView").setProperty("/questionWithOptions",true)}else{this.getView().getModel("objectDetailView").setProperty("/tableEditMode",false);this.getView().getModel("objectDetailView").setProperty("/questionWithOptions",false);var i=this.getView().byId("tableAnswers");var s=i.getItems();if(s.length>0){var o=[];for(var r=0;r<s.length;r++){var n=s[r].getBindingContext("ObjectOptionsModel").getObject();if(n.Id>0){n.Deleted=true;n=this.getBatchObject(n,"Option");this._oOptionsManager.updateEntry(n)}else{o.push(n)}}this._oOptionsManager.deleteItemsFromModel(this,o)}}if(t.getSelectedKey()==="QT1"||t.getSelectedKey()==="QT2"){this.getView().getModel("objectDetailView").setProperty("/isMandatoryVisible",false)}else{this.getView().getModel("objectDetailView").setProperty("/isMandatoryVisible",true)}},tableAddBtnPress:function(e){var t=this.getView().byId("tableAnswers");var i=this.getView().getBindingContext();var s=this._sId?this._sId:-1;if(i){s=i.getObject().Id}var o=1;if(t.getItems().length>0){o=Math.max.apply(Math,t.getItems().map(function(e){return e.getBindingContext("ObjectOptionsModel").getObject().Sequence}));o++}this._oOptionsManager.addToMiddlewareJsonModel(this,[{Id:this.getNextId(),QuestionId:s,Sequence:o,Deleted:false,Answer:"",DefaultAnswer:false,Value:1}])},tableDelBtnPress:function(e){var t=this.getView().byId("tableAnswers"),i=t.getSelectedContexts("ObjectOptionsModel");if(i.length===0&&t.getItems().length>0){a.error(this.getResourceBundle().getText("atLeastSellectOneItemToAction"),{icon:a.Icon.ERROR,title:this.getResourceBundle().getText("errorHeader"),actions:[a.Action.OK]});return}else if(t.getItems().length>0){var s=this.getModel(this._oOptionsManager.getModelName());var o=[];for(var r=0;r<i.length;r++){var n=s.getProperty(i[r].getPath());if(n.Id>0){n.Deleted=true;n=this.getBatchObject(n,"Option");this._oOptionsManager.updateEntry(n)}else{o.push(n)}}this._oOptionsManager.deleteItemsFromModel(this,o);t.getBinding("items").refresh(true);t.removeSelections()}},onOptionAnswerChange:function(e){var t=e.getSource().getBindingContext("ObjectOptionsModel"),i=jQuery.extend({},t.getObject());var s=t.getModel("ObjectOptionsModel");s.setProperty(t.getPath()+"/Answer",i.Answer);this._oOptionsManager.updateEntry(i)},onOptionDefaultChange:function(e){var t=e.getSource().getSelected();var i=e.getSource().getBindingContext("ObjectOptionsModel"),s=jQuery.extend({},i.getObject());s.DefaultAnswer=t;var o=i.getModel("ObjectOptionsModel");o.setProperty(i.getPath()+"/DefaultAnswer",t);this._oOptionsManager.updateEntry(s)},tableUpBtnPress:function(e){var t=this.getView().byId("tableAnswers");var i=e.getSource().getBindingContext("ObjectOptionsModel").getObject();var s=-1;for(var o=0;o<t.getItems().length;o++){if(t.getItems()[o].getBindingContext("ObjectOptionsModel").getObject().Id===i.Id){s=o;break}}var r=s-1;if(r===-1){r=t.getItems().length-1}var n=t.getItems()[r].getBindingContext("ObjectOptionsModel").getObject();var a=i.Sequence;i.Sequence=n.Sequence;n.Sequence=a;i=this.getBatchObject(i,"Option");n=this.getBatchObject(n,"Option");this._oOptionsManager.updateEntry(i);this._oOptionsManager.updateEntry(n);t.getBinding("items").refresh(true)},tableDownBtnPress:function(e){var t=this.getView().byId("tableAnswers");var i=e.getSource().getBindingContext("ObjectOptionsModel").getObject();var s=-1;for(var o=0;o<t.getItems().length;o++){if(t.getItems()[o].getBindingContext("ObjectOptionsModel").getObject().Id===i.Id){s=o;break}}var r=s+1;if(r>=t.getItems().length){r=0}var n=t.getItems()[r].getBindingContext("ObjectOptionsModel").getObject();var a=i.Sequence;i.Sequence=n.Sequence;n.Sequence=a;i=this.getBatchObject(i,"Option");n=this.getBatchObject(n,"Option");this._oOptionsManager.updateEntry(i);this._oOptionsManager.updateEntry(n);t.getBinding("items").refresh(true)},_onBeforeMatched:function(){if(this.getView()){this.getView().unbindElement();this.getView().unbindObject();this.getView().setBindingContext(null);var e=this.getView().byId("tableAnswers");e.destroyItems()}this.getView().getModel("objectDetailView").setProperty("/title","")},_onObjectMatched:function(e){if(!this.getOwnerComponent().getCurrentUser()||!this.getOwnerComponent().getCurrentUser().admin){this.getRouter().navTo("notAllowed",{},true);this.getModel("appView").setProperty("/layout","OneColumn")}else{this._sId=parseInt(e.getParameter("arguments").Id,10);this._sFormId=parseInt(e.getParameter("arguments").objectId,10);var t=this.getView().getModel("objectDetailView");t.setProperty("/editMode",false);t.setProperty("/createMode",false);t.setProperty("/tableEditMode",false);sap.ui.getCore().getEventBus().publish("_refreshDetail","objectId",{objectId:this._sFormId});sap.ui.getCore().getEventBus().publish("_refreshDetailSelection","questionId",{questionId:this._sId});sap.ui.getCore().getEventBus().publish("_refreshMasterSelection","formId",{formId:this._sFormId});this.getModel("appView").setProperty("/layout","ThreeColumnsEndExpanded");this._refreshDetailObjects()}},_onCreateObjectMatched:function(e){this._sObjectId=null;this._sFormId=parseInt(e.getParameter("arguments").objectId,10);var t=this.getView().getModel("objectDetailView");t.setProperty("/busy",true);t.setProperty("/editMode",true);t.setProperty("/createMode",true);t.setProperty("/isMandatoryVisible",false);this.getModel("appView").setProperty("/editMode",true);t.setProperty("/tableEditMode",false);t.setProperty("/questionWithOptions",false);t.setProperty("/showAdd",true);t.setProperty("/title",this.getResourceBundle().getText("createViewTitle"));sap.ui.getCore().getEventBus().publish("_refreshDetail","objectId",{objectId:this._sFormId});sap.ui.getCore().getEventBus().publish("_refreshMasterSelection","formId",{formId:this._sFormId});this.getModel("appView").setProperty("/layout","ThreeColumnsEndExpanded");this.getModel().metadataLoaded().then(function(){this.getModel().read("/QuestionSet",{filters:[new o("FormId",r.EQ,this._sFormId)],sorters:[new sap.ui.model.Sorter("Sequence",false)],success:function(e,t){var i=Math.max.apply(Math,e.results.map(function(e){return e.Sequence}));if(i<1){i=0}this.resetCreatedOContext("QuestionSet");this._oContext=this.getModel().createEntry("QuestionSet",{properties:{Id:-1,QtypeId:"QT1",FormId:this._sFormId,Sequence:i+1,RandomWeight:1,Mandatory:false,Deleted:false}});this.getView().setBindingContext(this._oContext);this.getView().getModel("objectDetailView").setProperty("/busy",false);this._oOptionsManager.updateData(this,this._getOptionFilters())}.bind(this),error:function(e){n.show(this.getResourceBundle().getText("errorHeader"))}.bind(this)})}.bind(this))},_initViewModel:function(){return new s({title:"",editMode:false,busy:false})},_refreshDetailObjects:function(){if(this._sId){this.getModel().metadataLoaded().then(function(){this._sObjectId=this._sId;var e=this.getView().getModel("objectDetailView");e.setProperty("/sObjectId",this._sObjectId);e.setProperty("/EditMode",true);e.setProperty("/showAdd",false);e.setProperty("/title",this.getResourceBundle().getText("detailViewTitle"));this._sObjectPath=this.getModel().createKey("QuestionSet",{Id:this._sId});this._bindView("/"+this._sObjectPath);this.resetCreatedOContext("QuestionSet");this._oOptionsManager.updateData(this,this._getOptionFilters())}.bind(this))}else{return}},_bindView:function(e){this.getView().getModel("objectDetailView").setProperty("/busy",false);this.getView().bindElement({path:e,parameteres:{$expand:"Form,Form/Icon"},events:{change:this._onBindingChange.bind(this),dataRequested:function(){this.getView().getModel("objectDetailView").setProperty("/busy",true)}.bind(this),dataReceived:function(){this.getView().getModel("objectDetailView").setProperty("/busy",false)}.bind(this)}})},_onBindingChange:function(){var e=this.getView(),t=e.getElementBinding();if(!t.getBoundContext()){this.getRouter().getTargets().display("detailObjectNotFound");return}var i=t.getPath();var s=e.getModel().getObject(i);this._sObjectId=s.Id;if(s.QtypeId==="QT3"||s.QtypeId==="QT4"||s.QtypeId==="QT7"){e.getModel("objectDetailView").setProperty("/questionWithOptions",true)}else{e.getModel("objectDetailView").setProperty("/questionWithOptions",false)}if(s.QtypeId==="QT1"||s.QtypeId==="QT2"){this.getModel("objectDetailView").setProperty("/isMandatoryVisible",false)}else{this.getModel("objectDetailView").setProperty("/isMandatoryVisible",true)}var o=this.getView().byId("tableAnswers");o.getBinding("items").refresh(true)},_refreshViews:function(){sap.ui.getCore().getEventBus().publish("_questionCountChange",{questionId:this._sObjectId});sap.ui.getCore().getEventBus().publish("_formChange",{formId:this._sFormId});this.getRouter().navTo("objectDetail",{objectId:this._sFormId,Id:this._sObjectId},true)},resetCreatedOContext:function(e,t){var i=this.getModel(),s;s=t?t:{};s.refreshAfterChange=false;if(this._oContext!==null){i.deleteCreatedEntry(this._oContext);this._oContext=null}i.setDeferredGroups(["changes"])},checkAnswers:function(){var e=this.getView().byId("tableAnswers");var t=e.getItems();var i=true;for(var s=0;s<t.length;s++){var o=t[s].getBindingContext("ObjectOptionsModel").getObject();if(o.Answer.length===0){i=false;break}}return i},_saveChangedObject:function(){var e=this.getModel(),t="mjzsoftadd"+(new Date).getTime();this.getView().getModel("objectDetailView").setProperty("/busy",true);e.setUseBatch(true);e.setDeferredGroups([t]);this.createOptionOdataRequests(t);if(this.getModel().hasPendingChanges()){var i=this.getView().getBindingContext().getObject();i=this.getBatchObject(i,"Question");var s=this.getView().getElementBinding().getPath();e.update(s,i,{success:function(){n.show(this.getResourceBundle().getText("successUpdateMessage"));this.getView().getModel("objectDetailView").setProperty("/busy",false);e.setDeferredGroups(["changes"]);this._refreshViews()}.bind(this),error:function(e){n.show(this.getResourceBundle().getText("errorUpdateMessage"));this.getView().getModel("objectDetailView").setProperty("/busy",false)}.bind(this)})}e.submitChanges({groupId:t,success:function(){n.show(this.getResourceBundle().getText("successUpdateMessage"));this.getView().getModel("objectDetailView").setProperty("/busy",false);e.setDeferredGroups(["changes"]);this._refreshViews()}.bind(this),error:function(e){n.show(this.getResourceBundle().getText("errorUpdateMessage"));this.getView().getModel("objectDetailView").setProperty("/busy",false)}.bind(this)})},_saveNewObject:function(){var e=this._oContext.getObject();e=this.getBatchObject(e,"Question");for(var t in e){if(e[t]===undefined){e[t]=""}}e.QtypeId=this.getView().byId("questionTypeSelectId").getSelectedKey();e.FormId=this._sFormId;var i=this.getModel(),s="mjzsoftadd"+(new Date).getTime();this.getView().getModel("objectDetailView").setProperty("/busy",true);i.setUseBatch(true);i.setDeferredGroups([s]);i.create("/QuestionSet",e,{success:function(e,t){this._sObjectId=e.Id;var o=this.createOptionOdataRequests(s,this._sObjectId);if(o.changesExist){i.submitChanges({groupId:s,success:function(){n.show(this.getResourceBundle().getText("successUpdateMessage"));this.getView().getModel("objectDetailView").setProperty("/busy",false);i.setDeferredGroups(["changes"]);this._refreshViews()}.bind(this),error:function(e){n.show(this.getResourceBundle().getText("errorCreationMessage"));this.getView().getModel("objectDetailView").setProperty("/busy",false)}.bind(this)})}else{n.show(this.getResourceBundle().getText("successUpdateMessage"));this.getView().getModel("objectDetailView").setProperty("/busy",false);i.setDeferredGroups(["changes"]);this._refreshViews()}}.bind(this),error:function(e){n.show(this.getResourceBundle().getText("errorCreationMessage"));this.getView().getModel("objectDetailView").setProperty("/busy",false)}.bind(this)})},_navFromDetailObjectToDetail:function(){var e=this.getView().getModel("objectDetailView");e.setProperty("/showAdd",false);e.setProperty("/busy",false);sap.ui.core.BusyIndicator.hide();this.getView().unbindElement();this.getModel("appView").setProperty("/layout","TwoColumnsMidExpanded");this.getRouter().navTo("object",{objectId:this._sFormId})},getNextId:function(){return this._iNextId--},_getOptionFilters:function(){var e=this.getView().getBindingContext();var t=0;if(e){t=this.getView().getModel().getProperty(e.getPath()).Id}if(t===0){var i=window.location.href;var s=i.split("/");var n=s[s.length-1];if(!isNaN(n)){t=parseInt(n,10)}}return new o({filters:[new o("QuestionId",r.EQ,t),new o("Deleted",r.EQ,false)],and:true})},getOptionsComparator:function(e,t){if(e.Id===t.Id){return true}return false},createOptionOdataRequests:function(e,t){var i="/OptionSet";var s=this.getView().getModel();var o=this._oOptionsManager.getDeletedItems(),r=this._oOptionsManager.getUpdatedItems(),n=this._oOptionsManager.getCreatedItems();s.setDeferredGroups([e]);for(var a=0;a<n.length;a++){var d=n[a];d.QuestionId=t?t:d.QuestionId;d=this.getBatchObject(d,"Option");s.create(i,d,{groupId:e})}for(var g=0;g<o.length;g++){var l=o[g];var h=s.createKey(i,{Id:l.Id});s.remove(h,{groupId:e})}for(var c=0;c<r.length;c++){var u=r[c];u=this.getBatchObject(u,"Option");var p=s.createKey(i,{Id:u.Id});s.update(p,u,{groupId:e})}return{groupId:e,changesExist:n!==0||r!==0||o!==0}},_getInitialFilter:function(){return new o({filters:[new o("QuestionId",r.EQ,this._sObjectId),new o("Deleted",r.EQ,false)],and:true})},_checkQuestionRequirements:function(){if(this.getView().getBindingContext()){var e=this.getView().getBindingContext().getObject(),t=e.QtypeId;if(t==="QT3"||t==="QT4"||t==="QT7"){var i=this.getView().byId("tableAnswers");var s=i.getItems();if(s.length<2){return false}else{return true}}else{return true}}else{return false}},onCloseView:function(){this.getModel("appView").setProperty("/editMode",false);this._navFromDetailObjectToDetail()},onCancelNewItem:function(){n.show(this.getResourceBundle().getText("MsgToastCanceled"));this.getModel("appView").setProperty("/editMode",false);this._navFromDetailObjectToDetail()},onCancelItemEdit:function(){n.show(this.getResourceBundle().getText("MsgToastCanceled"));var e=this.getView().getModel("objectDetailView");e.setProperty("/editMode",false);this.getModel("appView").setProperty("/editMode",false);e.setProperty("/tableEditMode",false);this.getView().getModel().resetChanges();this.getView().unbindElement();this._refreshDetailObjects()},onSaveDialog:function(){var e=this.getView().getModel("objectDetailView");e.setProperty("/editMode",false);this.getModel("appView").setProperty("/editMode",false);e.setProperty("/tableEditMode",false);if(this._sObjectId){this._saveChangedObject()}else{this._saveNewObject()}var t=this.getView().byId("tableAnswers");t.removeSelections()},onRegexValueHelpPressed:function(e){if(!this._oRegexDialog){d.load({name:"com.mjzsoft.QuestionnaireBuilder.view.fragment.DialogRegexSelector",controller:this}).then(function(e){this._oRegexDialog=e;this._oRegexDialog.setModel(this.getView().getModel());this.getView().addDependent(this._oRegexDialog);this._oRegexDialog.open()}.bind(this))}else{this._oRegexDialog.open()}},onRegexDialogLiveSearch:function(e){if(e.getParameter("value").length===0){this.onRegexDialogSearch(e)}},onRegexDialogSearch:function(e){var t=e.getParameter("value");var i=new o("Name",r.Contains,t);var s=e.getParameter("itemsBinding");s.filter([i])},onRegexDialogClose:function(e){var t=e.getParameter("selectedContexts");if(t&&t.length){var i=t[0].getObject(),s=this.getModel(),o=this.getView().getBindingContext().getPath();s.setProperty(o+"/Regex",i.Expression)}e.getSource().getBinding("items").filter([])}})});