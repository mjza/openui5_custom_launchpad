sap.ui.define(["./BaseController","../utils/Utils","../model/formatter","sap/ui/model/json/JSONModel","sap/m/MessageToast","sap/m/MessageBox","sap/ui/model/Sorter","sap/ui/model/Filter","sap/ui/model/FilterOperator"],function(e,t,i,s,o,n,r,a,d){"use strict";return e.extend("com.mjzsoft.QuestionnaireBuilder.controller.Detail",{formatter:i,_sCurrentSearchQuery:"",_oScrollContainer:null,_sObjectId:null,onInit:function(){this.setModel(this._initViewModel(),"detailView");this.getRouter().getRoute("object").attachPatternMatched(this._onObjectMatched,this);this.getRouter().getRoute("object").attachBeforeMatched(this._onBeforeMatched,this);this.initiateValidator();this.getValidator().removeAllMessages();this._resetDataSets();var e=sap.ui.getCore().getEventBus();e.subscribe("_questionCountChange",this._questionCountChange,this);e.subscribe("_refreshDetail","objectId",this._refreshDetail,this);e.subscribe("_refreshDetailSelection","questionId",this._refreshDetailSelection,this);e.subscribe("_deselectDetailSelection","objectDetailClose",this._deselectDetailSelection,this);this.getOwnerComponent().getModel().metadataLoaded().then(this._onMetadataLoaded.bind(this))},onAfterRendering:function(){var e=this.byId("formPage");this._oScrollContainer=this.byId(e.getId()+"-page-vertSB")},onExit:function(){var e=sap.ui.getCore().getEventBus();e.unsubscribe("_questionCountChange",this._questionCountChange,this);e.unsubscribe("_refreshDetail","objectId",this._refreshDetail,this);e.unsubscribe("_refreshDetailSelection","objectId",this._refreshDetailSelection,this);e.unsubscribe("_deselectDetailSelection","objectDetailClose",this._deselectDetailSelection,this)},onBeforeRebindTable:function(e){var t=e.getParameter("bindingParams");if(this._sObjectId){var i=this._getInitialFilter();t.filters.push(i)}t.sorter.push(new r("Sequence",false))},onPressEdit:function(e){this.getValidator().removeAllMessages();this.getModel("detailView").setProperty("/editMode",true);this.getModel("appView").setProperty("/editMode",true);this.getAppViewModel().setProperty("/layout","TwoColumnsMidExpanded")},onPressCancel:function(e){var i=this.getModel("detailView").getProperty("/changed");if(i||this._aDeletedQuestions.length>0||this._aUpdatedQuestionIds.length>0){var s=this.getResourceBundle();t.showDialog(this,s.getText("TitDialogCancel"),s.getText("TxtDialogCancel"),this.onCancelDialog.bind(this),true,undefined,s.getText("BtnNo"),s.getText("BtnYes"))}else{this.onCancelDialog()}},onCancelDialog:function(){o.show(this.getResourceBundle().getText("MsgToastCanceled"));this.getModel("detailView").setProperty("/editMode",false);this.getModel("appView").setProperty("/editMode",false);this.getView().unbindElement();this._rebindView();var e=this.getView().byId("tableQuestions");for(var t=0;t<this._aDeletedItems;t++){e.addItem(this._aDeletedItems[t])}this._resetDataSets();this.getModel("detailView").setProperty("/selectedItemId","")},onPressSaveEdit:function(e){var i=this.getModel("detailView").getProperty("/changed");if(i||this._aDeletedQuestions.length>0||this._aUpdatedQuestionIds.length>0){var s=this.getResourceBundle();t.showDialog(this,s.getText("saveMsg"),s.getText("saveBtnMsg"),this.onSaveDialog.bind(this),true,undefined,s.getText("BtnNo"),s.getText("BtnYes"))}else{this.getModel("detailView").setProperty("/editMode",false);this.getModel("appView").setProperty("/editMode",false)}},onSearch:function(e){var t=["Question"];this._sCurrentSearchQuery=e.getParameter("query");this.getView().byId("tableQuestions").setBusy(true);this._onSearchinTable(this._sCurrentSearchQuery,t)},onSearchLiveChange:function(e){var t=["Question"];if(e.getParameters().newValue.length===0){this._sCurrentSearchQuery="";this._onSearchinTable(this._sCurrentSearchQuery,t)}},onCreateBtnPress:function(e){this._resetAppViewModel("ThreeColumnsEndExpanded");this.getRouter().navTo("createObject",{objectId:this._sObjectId});this.getModel("detailView").setProperty("/selectedItemId","")},onDeleteBtnPress:function(e){var t=this.getView().byId("tableQuestions"),i=t.getSelectedContexts();if(i.length===0&&t.getItems().length>0){n.error(this.getResourceBundle().getText("atLeastSellectOneItemToAction"),{icon:n.Icon.ERROR,title:this.getResourceBundle().getText("errorHeader"),actions:[n.Action.OK]});return}else if(t.getItems().length>0){var s=t.getModel("QuestionsJsonModel"),o=t.getSelectedItems();o.forEach(function(e){var i=e.getBindingContext("QuestionsJsonModel").getObject();if(i.Id<0){var o=s.getData().QuestionSet;for(var n=0;n<o.length;n++){if(i.Id===o[n].Id){o.splice(n,1)}}t.getBinding("items").refresh()}else{this._aDeletedQuestions.push(i)}this._aDeletedItems.push(e);t.removeItem(e)}.bind(this))}},onTableItemPress:function(e){if(!this.getView().getModel("appView").getProperty("/editMode")){var t=e.getParameter("listItem");if(t&&t.getProperty("type")==="Navigation"){var i=t.getBindingContext("QuestionsJsonModel");var s=this.getView().byId("tableQuestions");var o=s.getModel("QuestionsJsonModel").getObject(i.getPath());this._navFromDetailToObjectDetail(o.Id);this.getModel("detailView").setProperty("/selectedItemId",o.Id)}}},onSaveDialog:function(){this.getModel("detailView").setProperty("/editMode",false);this.getModel("appView").setProperty("/editMode",false);if(this._sObjectId){this.updateQuestions()}},toggleFullScreen:function(){var e=this.getModel("detailView").getProperty("/fullscreen");this.getModel("detailView").setProperty("/fullscreen",!e);if(e){this.getAppViewModel().setProperty("/fullscreen",false);this.getAppViewModel().setProperty("/layout",this.getAppViewModel().getProperty("/previousLayout"))}else{this.getAppViewModel().setProperty("/previousLayout",this.getAppViewModel().getProperty("/layout"));this.getAppViewModel().setProperty("/layout","MidColumnFullScreen");this.getAppViewModel().setProperty("/fullscreen",true)}},onCloseDetailPress:function(){var e=this.getModel("detailView");if(e.getProperty("/editMode")){var i=e.getProperty("/changed");if(i||this._aDeletedQuestions.length>0||this._aUpdatedQuestionIds.length>0){var s=this.getResourceBundle();t.showDialog(this,s.getText("TitDialogClose"),s.getText("closeViewInEditMode"),this.onCloseView.bind(this),true,undefined,"","")}else{this.onCloseView()}}else{sap.ui.getCore().getEventBus().publish("_deselectMasterSelection","detailClose",{});e.setProperty("/fullscreen",false);this.getRouter().navTo("master")}},tableUpBtnPress:function(e){this.getModel("detailView").setProperty("/changed",true);var t=this.getView().byId("tableQuestions");var i=e.getSource().getBindingContext("QuestionsJsonModel").getObject();var s=-1;for(var o=0;o<t.getItems().length;o++){if(t.getItems()[o].getBindingContext("QuestionsJsonModel").getObject().Id===i.Id){s=o;break}}var n=s-1;if(n===-1){n=t.getItems().length-1}var r=t.getItems()[n].getBindingContext("QuestionsJsonModel").getObject();var a=i.Sequence;i.Sequence=r.Sequence;r.Sequence=a;if(!this._aUpdatedQuestionIds.includes(i.Id)){this._aUpdatedQuestionIds.push(i.Id)}if(!this._aUpdatedQuestionIds.includes(r.Id)){this._aUpdatedQuestionIds.push(r.Id)}t.getBinding("items").refresh(true)},tableDownBtnPress:function(e){this.getModel("detailView").setProperty("/changed",true);var t=this.getView().byId("tableQuestions");var i=e.getSource().getBindingContext("QuestionsJsonModel").getObject();var s=-1;for(var o=0;o<t.getItems().length;o++){if(t.getItems()[o].getBindingContext("QuestionsJsonModel").getObject().Id===i.Id){s=o;break}}var n=s+1;if(n>=t.getItems().length){n=0}var r=t.getItems()[n].getBindingContext("QuestionsJsonModel").getObject();var a=i.Sequence;i.Sequence=r.Sequence;r.Sequence=a;if(!this._aUpdatedQuestionIds.includes(i.Id)){this._aUpdatedQuestionIds.push(i.Id)}if(!this._aUpdatedQuestionIds.includes(r.Id)){this._aUpdatedQuestionIds.push(r.Id)}t.getBinding("items").refresh(true)},_initViewModel:function(){return new s({busy:false,tableBusy:false,delay:0,editMode:false,selectedItemId:""})},updateQuestions:function(){var e=this.getView().byId("tableQuestions").getModel("QuestionsJsonModel"),t=e.getData().QuestionSet.filter(function(e){return e.FormId===this._sObjectId}.bind(this));this.iNumberOfDoneRequests=t.length;if(this.iNumberOfDoneRequests>0){var i=[],s=this.getModel(),n="mjzsoftemail"+(new Date).getTime();s.setUseBatch(true);s.setDeferredGroups([n]);this._aDeletedQuestions.forEach(function(e){var t=this.getBatchObject(e,"Question");var l="/"+s.createKey("QuestionSet",t);t.Deleted=true;i.push(t.Id);this._updateRelatedItem(l,t,n,this._resetDataSets());this.getModel().read("/OptionSet",{filters:[new a("QuestionId",d.EQ,t.Id)],sorters:[new r("Sequence",false)],success:function(e,i){e.results.forEach(function(e){l="/"+s.createKey("OptionSet",e);e.Deleted=true;this._updateRelatedItem(l,t,n,this._resetDataSets())}.bind(this))}.bind(this),error:function(e){o.show(this.getResourceBundle().getText("errorHeader"))}})}.bind(this));t.forEach(function(e){var t=this.getBatchObject(e,"Question");if(t.Id<0){this.iNumberOfDoneRequests--;delete t.Id;s.create("/QuestionSet",t,{success:function(e,i){t.Id=e.Id;this.getModel("detailView").setProperty("/busy",false)}.bind(this),error:function(e){o.show(this.getAppViewModel().getProperty("/errorCreationMessage"));this.getModel("detailView").setProperty("/busy",false)}.bind(this)})}else if(!i.includes(t.Id)&&this._aUpdatedQuestionIds.includes(t.Id)){var r="/"+s.createKey("QuestionSet",t);this._updateRelatedItem(r,t,n,this._resetDataSets())}}.bind(this));s.submitChanges({groupId:n,success:function(){this._requestQuestions();sap.ui.getCore().getEventBus().publish("_formChange",{formId:this._sObjectId})}.bind(this)})}else{this._resetDataSets()}},onCloseView:function(){this.getModel("appView").setProperty("/editMode",false);sap.ui.getCore().getEventBus().publish("_deselectMasterSelection","detailClose",{});this.getModel("detailView").setProperty("/fullscreen",false);this.getRouter().navTo("master")},_updateRelatedItem:function(e,t,i,s){var o=this.getModel(),n="mjzsoftaddu"+(new Date).getTime()*(1+Math.random());o.update(e,t,{groupId:i,changeSetId:n,success:function(e,t){this.iNumberOfDoneRequests--;if(typeof s==="function"){s(e,t)}}.bind(this),error:function(e){this.iNumberOfDoneRequests--;if(typeof s==="function"){s(e)}}.bind(this)})},_onMetadataLoaded:function(){var e=this.getView().getBusyIndicatorDelay(),t=this.getModel("detailView");t.setProperty("/delay",0);t.setProperty("/busy",true);t.setProperty("/delay",e)},_navFromDetailToObjectDetail:function(e){this._resetAppViewModel("ThreeColumnsEndExpanded");this.getRouter().navTo("objectDetail",{objectId:this._sObjectId,Id:e});this.getModel("detailView").setProperty("/selectedItemId",e)},_onBeforeMatched:function(){if(this.getView()){this.getView().unbindElement();this.getView().unbindObject();this.getView().setBindingContext(null)}this.getAppViewModel().setProperty("/title","")},_onObjectMatched:function(e){if(!this.getOwnerComponent().getCurrentUser()||!this.getOwnerComponent().getCurrentUser().admin){this.getRouter().navTo("notAllowed",{},true);this.getModel("appView").setProperty("/layout","OneColumn")}else{this._sObjectId=parseInt(e.getParameter("arguments").objectId,10);this.getModel("detailView").setProperty("/fullscreen",false);this.getModel("detailView").setProperty("/editMode",false);this.getAppViewModel().setProperty("/layout","TwoColumnsMidExpanded");this.getAppViewModel().setProperty("/datesChanged",false);this._rebindView();sap.ui.getCore().getEventBus().publish("_refreshMasterSelection","formId",{formId:this._sObjectId})}},_onSearchinTable:function(e,t){var i=this.getView().byId("tableQuestions");i.getBinding("items").filter(new a({filters:[this._getInitialFilter(),this._getSearchFilter(e,t)],and:true}),sap.ui.model.FilterType.Application);i.setBusy(false)},_getInitialFilter:function(){return new a({filters:[new a("FormId",d.EQ,this._sObjectId),new a("Deleted",d.EQ,false)],and:true})},_getSearchFilter:function(e,t){var i=[];for(var s=0;s<t.length;s++){i.push(new a(t[s],d.Contains,e))}return new a({filters:i,and:false})},_rebindView:function(){this.getModel("detailView").setProperty("/busy",true);this.getModel().metadataLoaded().then(function(){this._sObjectPath="/"+this.getModel().createKey("FormSet",{Id:this._sObjectId});this._bindView(this._sObjectPath)}.bind(this))},_questionCountChange:function(e,t,i){this.getModel("detailView").setProperty("/selectedItemId",i.questionId);this._requestQuestions()},_requestQuestions:function(){this.getAppViewModel().setProperty("/tableBusy",true);this.getModel().read("/QuestionSet",{urlParameters:{$expand:"Qtype"},filters:[this._getInitialFilter()],sorters:[new r("Sequence",false)],success:function(e,t){var i=new s;i.setData({QuestionSet:e.results});this.setModel(i,"QuestionsJsonModel");this.getView().byId("smartTableQuestions").rebindTable();if(this._sCurrentSearchQuery.length>0){this._onSearchinTable(this._sCurrentSearchQuery,["Question"])}this.getAppViewModel().setProperty("/tableBusy",false)}.bind(this),error:function(e){o.show(this.getAppViewModel().getProperty("/errorHeader"));this.getAppViewModel().setProperty("/tableBusy",false)}.bind(this)})},_refreshDetail:function(e,t,i){this._sObjectId=i.objectId;this.getModel().metadataLoaded().then(function(){this._sObjectPath=this.getModel().createKey("FormSet",{Id:this._sObjectId});this._bindView("/"+this._sObjectPath)}.bind(this));sap.ui.getCore().getEventBus().unsubscribe("_refreshDetail","objectId",this._refreshDetail,this)},_refreshDetailSelection:function(e,t,i){this.getModel("detailView").setProperty("/selectedItemId",i.questionId);var s=this.getView().byId("tableQuestions");var o=s.getItems();if(o.length===0){s.attachEventOnce("updateFinished",function(){var e=s.getItems();this._checkItemInit(e,i.questionId)}.bind(this))}else{this._checkItemInit(o,i.questionId)}sap.ui.getCore().getEventBus().unsubscribe("_refreshDetailSelection","questionId",this._refreshDetailSelection,this)},_checkItemInit:function(e,t){var i=e.find(function(e){var i=e.getBindingContext("QuestionsJsonModel").sPath;var s=this.getView().getModel("QuestionsJsonModel").getProperty(i);return s.Id===t}.bind(this));if(i){jQuery.sap.delayedCall(0,null,function(){if(this._oScrollContainer){var e=i.$().offset();this._oScrollContainer.setScrollPosition(e.top)}}.bind(this))}else{this._resetAppViewModel("TwoColumnsMidExpanded")}},_deselectDetailSelection:function(){this.getModel("detailView").setProperty("/selectedItemId","")},_bindView:function(e){this.getAppViewModel().setProperty("/flexBoxDirection","Column");this.getModel("detailView").setProperty("/busy",false);this.getView().bindElement({path:e,parameters:{$expand:"Icon"},events:{change:this._onBindingChange.bind(this),dataRequested:function(){this.getModel("detailView").setProperty("/busy",true)}.bind(this),dataReceived:function(){this.getModel("detailView").setProperty("/busy",false)}.bind(this)}})},_onBindingChange:function(){var e=this.getView(),t=e.getElementBinding();if(!t.getBoundContext()){this.getRouter().getTargets().display("detailObjectNotFound");return}var i=e.getModel().getObject(t.getPath());this._sObjectId=i.Id;this._requestQuestions()},_resetDataSets:function(){this.getModel("detailView").setProperty("/changed",false);this._aDeletedQuestions=[];this._aUpdatedQuestionIds=[];this._aDeletedItems=[]},_setViewBusy:function(e){if(e){this.getModel("detailView").setProperty("/busy",true);sap.ui.core.BusyIndicator.show()}else{this.getModel("detailView").setProperty("/busy",false);sap.ui.core.BusyIndicator.hide()}},_resetAppViewModel:function(e){this.getAppViewModel().setProperty("/layout",e);this.getAppViewModel().setProperty("/flexBoxDirection","Column")},onEditFormBtnPress:function(e){if(!this._oCreateFormDialog){this._oCreateFormDialog=sap.ui.xmlfragment("com.mjzsoft.QuestionnaireBuilder.view.fragment.AddForm",this);this.getView().addDependent(this._oCreateFormDialog)}var t=this.getView().getModel().getProperty(this._sObjectPath,null,true);var i=this.getBatchObject(t,"Form");i.IconSrc=t.Icon.Source;var o=new s;o.setData(i);this._oCreateFormDialog.setModel(o,"oFragViewModel");this._oCreateFormDialog.getModel("appView").setProperty("/CreateEditSurveyTitle",this.getResourceBundle().getText("EditSurveyTitle"));this._oCreateFormDialog.getModel("appView").setProperty("/viewIcon",false);this._oCreateFormDialog.open()},onCancelForm:function(){this.getAppViewModel().setProperty("/datesChanged",false);if(this._oCreateFormDialog){if(this._oCreateFormDialog.isOpen()){this._oCreateFormDialog.close()}}},onSaveForm:function(e){this.getAppViewModel().setProperty("/datesChanged",false);var t=sap.ui.core.format.DateFormat.getDateTimeInstance(),i=sap.ui.getCore().byId("startDateTime").getValue(),s=sap.ui.getCore().byId("endDateTime").getValue(),n=t.parse(i),r=t.parse(s),a=this.getModel(),d=e.getSource().getBindingContext().sPath,l="mjzsoftadd"+(new Date).getTime();var u=this._oCreateFormDialog.getModel("oFragViewModel").getData();u=this.getBatchObject(u,"Form");u.ValidFrom=n;u.ValidTo=r;a.setUseBatch(true);a.setDeferredGroups([l]);this._setViewBusy(false);a.update(d,u,{groupId:l,success:function(){o.show(this.getResourceBundle().getText("successUpdateMessage"));this._setViewBusy(false);this._oCreateFormDialog.close();sap.ui.getCore().getEventBus().publish("_formChange",{formId:this._sObjectId})}.bind(this),error:function(e){o.show(this.getResourceBundle().getText("MsgToastError"));this._setViewBusy(false);this._oCreateFormDialog.close()}.bind(this)});a.submitChanges({groupId:l})},onAfterCloseDialog:function(){if(this._oCreateFormDialog){this._oCreateFormDialog.destroy();this._oCreateFormDialog=null}},onStartDateChange:function(e){this.getAppViewModel().setProperty("/datesChanged",true);this.getValidator().validate(sap.ui.getCore().byId("startDateTime"));this.createFormInputsValidation()},onEndDateChange:function(e){this.getAppViewModel().setProperty("/datesChanged",true);this.createFormInputsValidation()},onSwitchChange:function(e){var t=e.getSource().getBindingContext();var i=t.getModel("oFragViewModel");var s=t.getPath()+"/Universal";i.setProperty(s,e.getSource().getState())},createFormInputsValidation:function(){var e=sap.ui.getCore().byId("startDateTime"),t=sap.ui.getCore().byId("endDateTime"),i=sap.ui.getCore().byId("titleId").getValue();if(i.length===0||e.getValue().length===0||e.getValueState()==="Error"||t.getValue().length===0||t.getValueState()==="Error"){sap.ui.getCore().byId("SaveBtnId").setEnabled(false)}else{sap.ui.getCore().byId("SaveBtnId").setEnabled(true)}},onCreateFormTitleLiveChange:function(e){this.createFormInputsValidation()}})});