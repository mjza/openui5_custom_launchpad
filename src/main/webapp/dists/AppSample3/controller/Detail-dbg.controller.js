sap.ui.define(["./BaseController","../utils/Utils","sap/ui/model/json/JSONModel","../model/formatter","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageToast","sap/m/MessageBox"],function(e,t,i,r,o,n,s,a){"use strict";return e.extend("com.mjzsoft.UserSurveys.controller.Detail",{formatter:r,aGroups:["newEntry"],onInit:function(){var e=new i({busy:false,delay:0,fullscreen:false});this.getRouter().getRoute("object").attachPatternMatched(this._onObjectMatched,this);this.setModel(e,"detailView");this.getOwnerComponent().getModel().metadataLoaded().then(this._onMetadataLoaded.bind(this))},onAfterRendering:function(){var e=this.getModel().getDeferredGroups().concat(this.aGroups);this.getModel().setDeferredGroups(e)},getSurveySelectorDialog:function(){return sap.ui.xmlfragment("com.mjzsoft.UserSurveys.view.DialogSurveySelector",this)},onPressAdd:function(e){if(!this._SurveySelectorDialog){this._SurveySelectorDialog=this.getSurveySelectorDialog();this.getView().addDependent(this._SurveySelectorDialog)}this._SurveySelectorDialog.setModel(this.getModel());this._SurveySelectorDialog.open();var t=this._buildFilterForForms();this._SurveySelectorDialog.getBinding("items").filter(t)},handleCloseDialog:function(e){var t=e.getParameter("selectedContexts");var i=t.map(function(e){return e.getObject().Id}).join(", ");var r=e.getSource().getBindingContext().getObject();var o={UserId:r.Id,FormId:parseInt(i,10)};var n=this.getBatchObject(o,"Survey");var s=this.getModel();s.create("/SurveySet",n,{groupId:"newEntry",success:function(){this.getModel().refresh(true)}.bind(this)});s.submitChanges({groupId:"newEntry"})},onPressDelete:function(e){var i=this.getView().byId("idDetailTableLocationSet");if(i.getSelectedItems().length===0){return}var r=this.getResourceBundle();t.showDialog(this,r.getText("qRemoveSurveyTitle"),r.getText("qRemoveSurvey"),this.onDelete.bind(this),true)},onDelete:function(){var e=this.getView().byId("idDetailTableLocationSet"),t=e.getSelectedItems();var i="mjzsoftoption"+(new Date).getTime();this.iNumberOfDoneRequests=t.length;var r=function(){if(this.iNumberOfDoneRequests===0){this.getModel().refresh(true)}}.bind(this);var s=this.getModel().getDeferredGroups().concat([i]);this.getModel().setDeferredGroups(s);var l=this.getView().getBindingContext().getObject().Id;var d=[];for(var g=0;g<t.length;g++){var u=this.getView().getModel();var h=t[g].getBindingContext().getObject().Form.__ref;var c=u.getProperty("/"+h);var p=false;for(var f=0;f<c.Questions.__list.length;f++){var v=c.Questions.__list[f];var m=u.getProperty("/"+v);var y=u.bindList("/"+v+"/Answers",null,null,[new o({path:"UserId",operator:n.EQ,value1:l}),new o({path:"QuestionId",operator:n.EQ,value1:m.Id})]);if(y.getLength()>0){p=true;break}}if(p){d.push({name:c.Name})}}if(d.length>0){var w="";for(var g=0;g<d.length;g++){w+=d[g].name+"\n"}a.error(this.getResourceBundle().getText("errorNotRemovableSurveys",[w]),{icon:a.Icon.ERROR,title:this.getResourceBundle().getText("errorHeader"),actions:[a.Action.OK]});return}this.getModel("detailView").setProperty("/busy",true);var S=function(){for(var e=0;e<t.length;e++){var o=t[e].getBindingContext().getPath();this._deleteRelatedItem(o,i,r)}this.getModel().submitChanges({groupId:i})}.bind(this);var b=function(e){for(var t=0;t<e.length;t++){var r=this.getModel().createKey("AnswerSet",{Id:e[t].Id});this._deleteRelatedItem("/"+r,i)}S()}.bind(this);var M=function(e){var t=[];var i=e.length;var r=this.getView().getElementBinding().getPath(),s=this.getView().getElementBinding().getModel().getObject(r),a=s.Id;for(var l=0;l<e.length;l++){var d=[new o("QuestionId",n.EQ,e[l].Id),new o("UserId",n.EQ,a)];this.getModel().read("/AnswerSet",{filters:d,success:function(e){t=t.concat(e.results);i--;if(i===0){b(t)}},error:function(){}})}}.bind(this);var I=[];var P=t.length;for(var g=0;g<t.length;g++){var C=t[g].getBindingContext().getPath();this.getModel().read("/QuestionSet",{filters:[new o("FormId",n.EQ,this.getModel().getProperty(C).FormId)],success:function(e){I=I.concat(e.results);P--;if(P===0){M(I)}},error:function(){}})}},_deleteRelatedItem:function(e,t,i){var r=this.getModel();r.remove(e,{groupId:t,success:function(){if(typeof i==="function"){this.iNumberOfDoneRequests--;i()}}.bind(this),error:function(e){if(typeof i==="function"){this.iNumberOfDoneRequests--;i()}}.bind(this)})},handleSearch:function(e){this._applySearch(e)},liveSearch:function(e){if(e.getParameters().value.length===0){this._applySearch(e)}},_applySearch:function(e){var t=e.getParameter("value");var i=this._buildFilterForForms(t);var r=e.getSource().getBinding("items");r.filter(i,"Application")},calcQuestionCount:function(e){var t=this.aQuestions.filter(function(t){return t.FormId===e&&t.Deleted===false});return t.length},_onObjectMatched:function(e){var t=e.getParameter("arguments").objectId;this.getModel("appView").setProperty("/layout","TwoColumnsMidExpanded");this.getModel().metadataLoaded().then(function(){var e=this.getModel().createKey("UserSet",{Id:t});this._bindView("/"+e);var i=[new o("UserId",n.EQ,t)];this.getView().byId("idDetailTableLocationSet").getBinding("items").filter(i);this.getModel("detailView").setProperty("/busy",false);this.getModel().read("/QuestionSet",{success:function(e){this.aQuestions=e.results}.bind(this)})}.bind(this))},_bindView:function(e){var t=this.getModel("detailView");t.setProperty("/busy",false);this.getView().bindElement({path:e,events:{change:this._onBindingChange.bind(this),dataRequested:function(){t.setProperty("/busy",true)},dataReceived:function(){t.setProperty("/busy",false)}}})},_onBindingChange:function(){var e=this.getView(),t=e.getElementBinding();if(!t.getBoundContext()){this.getRouter().getTargets().display("detailObjectNotFound");this.getOwnerComponent().oListSelector.clearMasterListSelection();return}var i=t.getPath(),r=e.getModel().getObject(i),o=this.getModel("detailView");this.getOwnerComponent().oListSelector.selectAListItem(i);o.setProperty("/title",r.FirstName+" "+r.LastName)},_onMetadataLoaded:function(){var e=this.getView().getBusyIndicatorDelay(),t=this.getModel("detailView");t.setProperty("/delay",0);t.setProperty("/busy",true);t.setProperty("/delay",e)},_buildFilterForForms:function(e){var t=this.getView().byId("idDetailTableLocationSet").getItems();var i=this.getModel();var r=[new o("Deleted",n.EQ,false),new o("ValidTo",n.GE,new Date)];for(var s=0;s<t.length;s++){var a=i.getProperty(t[s].getBindingContext().sPath).FormId;r.push(new o("Id",n.NE,a))}if(e){r.push(new o("Name",n.Contains,e))}var l=new o({filters:r,and:true});return l},onCloseDetailPress:function(){this.getModel("appView").setProperty("/actionButtonsInfo/midColumn/fullScreen",false);this.getOwnerComponent().oListSelector.clearMasterListSelection();this.getRouter().navTo("master")},toggleFullScreen:function(){var e=this.getModel("appView").getProperty("/actionButtonsInfo/midColumn/fullScreen");this.getModel("appView").setProperty("/actionButtonsInfo/midColumn/fullScreen",!e);this.getModel("detailView").setProperty("/fullscreen",!e);if(e){this.getModel("appView").setProperty("/layout",this.getModel("appView").getProperty("/previousLayout"))}else{this.getModel("appView").setProperty("/previousLayout",this.getModel("appView").getProperty("/layout"));this.getModel("appView").setProperty("/layout","MidColumnFullScreen")}},onPressItem:function(e){this.oCrossAppNavigator=sap.ushell.Container.getService("CrossApplicationNavigation");var t=this.getView().getModel().getProperty(e.getSource().getBindingContext().getPath());var i={target:{semanticObject:"Action",action:"toapp_ask_survey"},params:{UserId:t.UserId,FormId:t.FormId}};var r=this.oCrossAppNavigator&&this.oCrossAppNavigator.hrefForExternal(i)||"";this.oCrossAppNavigator.isNavigationSupported([i]).done(function(e){if(e[0].supported===true){this.oCrossAppNavigator.toExternal({target:{shellHash:r}})}else{s.show(this.getResourceBundle().getText("errorNavigationNotSupport"))}}.bind(this)).fail(function(){s.show(this.getResourceBundle().getText("errorNavigationNotSupport"))}.bind(this))}})});