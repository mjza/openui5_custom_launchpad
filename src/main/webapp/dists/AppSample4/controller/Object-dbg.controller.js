sap.ui.define(["./BaseController","../model/formatter","../utils/Utils","../utils/ControlHelper","../control/InfiniteWizard","sap/ui/core/routing/History","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/core/ValueState","sap/ui/core/CustomData","sap/ui/core/Item","sap/m/MessageToast","sap/m/RadioButtonGroup","sap/m/VBox","sap/m/WizardStep"],function(e,t,s,r,i,o,n,a,u,d,l,h,g,f,c,p){"use strict";const _={_RATINGINDICATOR:"sap.m.RatingIndicator",_SWITCH:"sap.m.Switch",_RADIOBUTTON:"sap.m.RadioButton",_CHECKBOX:"sap.m.CheckBox",_INPUT:"sap.m.Input",_TEXTAREA:"sap.m.TextArea",_SELECT:"sap.m.Select"};return e.extend("com.mjzsoft.Survey.controller.Object",{formatter:t,onInit:function(){this._oDataModel=[];this._aFinishedQuestions=[];this._initViewModel();this.getRouter().getRoute("object").attachPatternMatched(this._onObjectMatched,this)},onNavBack:function(){var e=o.getInstance().getPreviousHash();if(e!==undefined){history.go(-1)}else{this._navToWorkList()}},onPressCompleteWizard:function(e){var t=this.getResourceBundle();s.showDialog(this,t.getText("titleSaveDialog"),d.Warning,t.getText("txtDialogAdd"),this._collectWizardData.bind(this),true,t.getText("btnYes"),true,t.getText("btnNo"),true)},_collectWizardData:function(){var e=this._getWizardFields(),t=[];for(var s=0;s<e.length;s++){var r=e[s],i=r.getAggregation("customData");for(var o=0;o<this._oDataModel.length;o++){var n=i[0].getProperty("value"),a=this._oDataModel[o],u=r.getMetadata().getName();if(n!==a.QuestionId){continue}if(a.M){t.push(this._generateOptionObject(i[1].getProperty("value"),n,true));continue}switch(u){case _._INPUT:a.Answer=r.getProperty("value");t.push(a);break;case _._TEXTAREA:a.Answer=r.getProperty("value");t.push(a);break;case _._RATINGINDICATOR:a.Answer=String(r.getProperty("value"));t.push(a);break;case _._SWITCH:if(r.getProperty("state")){a.Answer="1"}else{a.Answer="0"}t.push(a);break;case _._RADIOBUTTON:if(r.getProperty("selected")){a.OptionId=i[1].getProperty("value");t.push(a)}break;case _._SELECT:if(r.getSelectedItem().getProperty("key")){a.OptionId=parseInt(r.getSelectedItem().getProperty("key"),10);t.push(a)}break;case _._CHECKBOX:if(r.getProperty("selected")){a.OptionId=i[1].getProperty("value");t.push(a)}break}}}this._preprocressDataAndSave(t)},onLiveChangeRatingIndicator:function(e){this._oWizard.setShowNextButton(true)},onCompleteStepInWizard:function(e){var t=e.getSource().getTitle(),s,r=-1,i;for(var o=0;o<this._aQuestions.length&&r<0;o++){if(this._aQuestions[o].Question===t){r=o+1;s=this._aQuestions[r]}}if(!s){return}i=s.Qtype.Ui5Class;if(s.Mandatory){if(i===_._SWITCH||i===_._RATINGINDICATOR){this._oWizard.setShowNextButton(true);return}this.checkShowNextButton(i,r);return}this._oWizard.setShowNextButton(true)},checkShowNextButton:function(e,t){var s=this._oWizard.getSteps()[t],r=s.getAggregation("content")[0],i=e===_._RADIOBUTTON?r.getButtons():r.getItems();this._oWizard.setShowNextButton(false);for(var o=0;o<i.length;o++){if(this._isControlHavingValue(i[o],e)){this._oWizard.setShowNextButton(true);break}}},onLiveChangeInput:function(e){var t=e.getSource();if(e.getParameters().newValue.length>2){this._oWizard.setShowNextButton(true);t.setValueState(d.None)}else{this._oWizard.setShowNextButton(false);t.setValueStateText(this.getResourceBundle().getText("txtValueState"));t.setValueState(d.Error)}},onSelectCheckBox:function(e){var t=e.getSource().getParent(),s;if(t){s=t.getItems();for(var r=0;r<s.length;r++){if(s[r].getSelected()){this._oWizard.setShowNextButton(true);return}else{this._oWizard.setShowNextButton(false)}}}},onSelectRadioButton:function(e){var t=e.getSource().getParent(),s;if(t){s=t.getButtons();for(var r=0;r<s.length;r++){if(s[r].getSelected()){this._oWizard.setShowNextButton(true);return}else{this._oWizard.setShowNextButton(false)}}}},_onObjectMatched:function(e){var t=e.getParameter("arguments"),s=t.objectId,r=this.getModel(),i;this._resetViewModelAndLocalData(t);this._destroyWizardFromPreviousSurvey();this.startAppBusy();r.metadataLoaded().then(()=>{i=this.getModel().createKey("SurveySet",{Id:this._sUserSurveyID});this._bindView("/"+i);this._readQuestionsSet(s)})},_initViewModel:function(){this._oViewModel=this._initObjectViewModel();this.setModel(this._oViewModel,"viewModel")},_initObjectViewModel:function(){return new n({userName:"",submitVisible:true,userID:"",icon:"",titState:d.None,isSurveyFinished:false,FilteredQuestions:[],PossibleAnswers:[],UserAnswers:[]})},_resetViewModelAndLocalData:function(e){this._oViewModel.setProperty("/isSurveyFinished",e.finished==="1"?true:false);this._oViewModel.setProperty("/userID",e.userID);this._oViewModel.setProperty("/FilteredQuestions",[]);this._oViewModel.setProperty("/PossibleAnswers",[]);this._oViewModel.setProperty("/UserAnswers",[]);this._aFinishedQuestions=[];this._sUserSurveyID=e.sUserSurveyID},_destroyWizardFromPreviousSurvey:function(){var e=this.byId("idVerticalLayout").getContent();if(e.length>1){if(e[1].getMetadata().getName()==="sap.m.Wizard"){e[1].destroy()}}},_getWizardFields:function(){var e=r.getRelevantFields(sap.ui.getCore().byFieldGroupId("fieldGroupSurvey")),t=[],s;for(var i=0;i<e.length;i++){s=e[i].getMetadata().getName();if(s===_._CHECKBOX){if(e[i].getSelected()){t.push(e[i])}}else{t.push(e[i])}}return t},_generateOptionObject:function(e,t,s){var r={Answer:"",OptionId:!e?"":e,QuestionId:t,M:s,UserId:this._oViewModel.getProperty("/userID")};return r},_preprocressDataAndSave:function(e){this.startAppBusy();var t=this.getModel(),s="mjzsoftadd1"+(new Date).getTime(),r=function(){if(this.iNumberOfDoneRequests===0){this.stopAppBusy();this.getModel().setDeferredGroups(["changes"]);this._updateUserSurvey()}}.bind(this);t.setUseBatch(true);t.setDeferredGroups([s]);this.iNumberOfDoneRequests=0;for(var i=0;i<e.length;i++){var o=e[i];delete o.M;if(o.OptionId===""){delete o.OptionId}this.iNumberOfDoneRequests++;this._saveAnswerForQuestion(o,s,r)}t.submitChanges({groupId:s})},_saveAnswerForQuestion:function(e,t,s){var r=this.getModel();r.create("/AnswerSet",e,{groupId:t,success:(e,t)=>{this.iNumberOfDoneRequests--;if(typeof s==="function"){s(e,t)}},error:e=>{this.iNumberOfDoneRequests--;if(typeof s==="function"){s(e)}}})},_updateUserSurvey:function(){this.startAppBusy();var e={DoneAt:new Date},t=this.getModel(),s="/"+t.createKey("SurveySet",{Id:this._sUserSurveyID});t.setDeferredGroups(["changes"]);t.update(s,e,{success:()=>{this._oWizard.destroy();g.show(this.getResourceBundle().getText("Success"));this._navToWorkList()},error:e=>{this._oWizard.destroy();this._navToWorkList()}})},_readQuestionsSet:function(e){var t="/QuestionSet",r={$expand:"Qtype,Form,Form/Icon"},i=[new a({filters:[new a("Deleted",u.EQ,"false"),new a("FormId",u.EQ,parseInt(e,10))],and:true})];s.readData(this.getModel(),t,r,i).then(e=>{var t=e.results;this._oViewModel.setProperty("/icon",t.length?t[0].Form.Icon.Source:"sap-icon://survey");this._oViewModel.setProperty("/FilteredQuestions",t);var s=[];for(var r=0;r<t.length;r++){s.push(t[r].Id)}this._getPossibleAnswerSet(s)}).fail(()=>{this.stopAppBusy();return})},_bindView:function(e){this.getView().bindElement({path:e,parameters:{expand:"Form, User"},events:{dataRequested:()=>{this.startAppBusy()},dataReceived:()=>{this.stopAppBusy()}}})},_getPossibleAnswerSet:function(e){if(!e||e.length===0){return}var t=[];for(var r=0;r<e.length;r++){t.push(new a("QuestionId",u.EQ,e[r]))}var i=[new a({filters:[new a("Deleted",u.EQ,"false"),new a({filters:t,and:false})],and:true})],o=this.getModel();s.readData(o,"/OptionSet",{},i).then(t=>{this.byId("idContainer").removeAllItems();if(this._oWizard){this._oWizard.destroy()}this._oViewModel.setProperty("/PossibleAnswers",t.results);if(this._oViewModel.getProperty("/isSurveyFinished")){this._getAnswerSetForUser(e)}else{this._buildWizardForOpenSurvey()}})},_buildWizardForOpenSurvey:function(){var e=this.byId("idVerticalLayout");this._oWizard=new i({finishButtonText:this.getResourceBundle().getText("btnSave"),complete:this.onPressCompleteWizard.bind(this)});e.addContent(this._oWizard);this._buildWizardStepsForOpenQuestions()},_getAnswerSetForUser:function(e){if(!e||e.length===0){return}var t=[];for(var r=0;r<e.length;r++){t.push(new a("QuestionId",u.EQ,e[r]))}var i="/AnswerSet",o=this.getModel(),n=[new a({filters:[new a("UserId",u.EQ,this._oViewModel.getProperty("/userID")),new a({filters:t,and:false})],and:true})],d={$expand:"User, Option, Question, Question/Qtype"};this.startAppBusy();s.readData(o,i,d,n).then(e=>{this._oViewModel.setProperty("/UserAnswers",e.results);this._buildFormForFinishedSurveys()}).fail(()=>{this.stopAppBusy()})},_buildFormForFinishedSurveys:function(){var e=this.byId("idContainer"),t=this._oViewModel.getProperty("/FilteredQuestions"),s=r.sortDataStructure(t),i=this._oViewModel.getProperty("/UserAnswers");for(var o=0;o<s.length;o++){var n=s[o].Qtype.Ui5Class,a=s[o].Mandatory,u=[],d=-1,l=this._extractAnswersForQuestion(s[o],i),g=this._extractMatchingOptionsWithQuestion(s[o].Id),f=r.sortDataStructure(g);for(var c=0;c<f.length;c++){var p=f[c],w=this._isOptionSelected(l,p.Id),S;if(n===_._CHECKBOX){S=this._generateNewCheckBoxControl(p.Answer,w,false);u.push(S)}if(n===_._RADIOBUTTON){S=this._generateNewRadioButtonControl(p.Answer,w,false);u.push(S)}if(n===_._RADIOBUTTON&&c===f.length-1){for(var v=0;d<0&&v<u.length;v++){if(u[v].sID===S.sID&&u[v].getSelected()){d=v}}}}if(u.length===0){var I=[],C;for(c=0;c<f.length;c++){for(v=0;v<l.length;v++){if(l[v].OptionId===f[c].Id){C=f[c].Id;break}}I.push(new h({key:f[c].Id,text:f[c].Answer}))}if(n===_._SELECT){u.push(this._generateNewSelectForFinishedSurvey(C,I))}else{var y;if(l.length===1){y=l[0].Answer}var A=r.generateParametersForControl(n,y,false,this);var N=r.generateNewControl(n,A,undefined,undefined,a);u.push(N)}}var m;if(n===_._RADIOBUTTON){m=this._generateNewRadioButtonGroup(u,d)}else{m=this._generateNewVBox(u)}m.addStyleClass("sapUiLargeMarginBegin");e.addItem(r.generateNewPanel(o+1,s[o].Question,[m]))}this.stopAppBusy()},_extractAnswersForQuestion:function(e,t){var s=[];for(var r=0;r<t.length;r++){if(t[r].QuestionId===e.Id){s.push(t[r])}}return s},_extractMatchingOptionsWithQuestion:function(e){var t=this._oViewModel.getProperty("/PossibleAnswers"),s=[];for(var r=0;r<t.length;r++){if(t[r].QuestionId===e){s.push(t[r])}}return s},_isOptionSelected:function(e,t){for(var s=0;s<e.length;s++){if(e[s].OptionId===t){return true}}return false},_buildWizardStepsForOpenQuestions:function(){var e=[],t=this._oViewModel.getProperty("/PossibleAnswers"),s=this._oViewModel.getProperty("/FilteredQuestions"),i=r.sortDataStructure(s);this._oDataModel=[];this._aQuestions=i;for(var o=0;o<i.length;o++){e=[];var n=i[o],a=n.Mandatory,u=n.Id,d=n.Qtype.Ui5Class,l=n.Regex,g=this._extractMatchingOptionsWithQuestion(u),f=-1,c=r.sortDataStructure(g);for(var p=0;p<c.length;p++){var w=c[p].DefaultAnswer?true:false,S=c[p].Answer,v;if(d===_._CHECKBOX){v=this._generateNewCheckBoxControl(S,w,true);this._addCustomDataForControl(v,u,"ID");this._addCustomDataForControl(v,c[p].Id,"subItems");e.push(v);if(a){v.attachSelect(this.onSelectCheckBox.bind(this))}}if(d===_._RADIOBUTTON){v=this._generateNewRadioButtonControl(S,w,true);this._addCustomDataForControl(v,u,"ID");this._addCustomDataForControl(v,c[p].Id,"subItems");e.push(v);if(a){v.attachSelect(this.onSelectRadioButton.bind(this))}for(var I=0;w&&I<e.length&&f<0;I++){f=e[I].sID===v.sID?I:-1}}}if(e.length===0){var C=[],y=[],A=[],N;for(p=0;p<t.length;p++){if(t[p].QuestionId===u){C.push(t[p])}}y=r.sortDataStructure(C);for(p=0;p<y.length;p++){if(y[p].DefaultAnswer){N=y[p].Id}A.push(new h({key:y[p].Id,text:y[p].Answer}))}if(d===_._SELECT){this._addCustomDataForControl(this._generateNewSelectControl(N,A),u,"ID");e.push(this._generateNewSelectControl(N,A))}else{var m=r.generateParametersForControl(d,undefined,true,this),B=r.generateNewControl(d,m,l,this._oWizard,n.Mandatory);if(a){this._manageMandatoryForControl(B,d)}this._addCustomDataForControl(B,u,"ID");e.push(B)}}var D;if(d===_._RADIOBUTTON){if(!a){e.push(this._generateNewRadioButtonControl(this.getResourceBundle().getText("btnRadioNone"),false,true))}D=this._generateNewRadioButtonGroup(e,f)}else{D=this._generateNewVBox(e)}this._oWizard.addStep(this._generateNewWizardStep(D,n.Question));this._oDataModel.push(this._generateOptionObject(null,u,d===_._CHECKBOX))}if(i.length>0&&i[0].Mandatory){var T=i[0].Qtype.Ui5Class;if(T===_._RATINGINDICATOR||T===_._SWITCH){this._oWizard.setShowNextButton(true)}else if(T===_._RADIOBUTTON){this._getStepContentAndChecksStatus(true,T)}else{this._getStepContentAndChecksStatus(false,T)}}this.stopAppBusy()},_getStepContentAndChecksStatus:function(e,t){this._oWizard.setShowNextButton(false);var s=this._oWizard.getSteps()[0],r=s.getAggregation("content")[0],i=e?r.getButtons():r.getItems();for(var o=0;o<i.length;o++){if(i[o]&&this._isControlHavingValue(i[o],t)){this._oWizard.setShowNextButton(true);break}}},_isControlHavingValue:function(e,t){switch(t){case _._RATINGINDICATOR:case _._INPUT:case _._TEXTAREA:return e.getValue()?true:false;case _._RADIOBUTTON:case _._CHECKBOX:return e.getSelected()?true:false;case _._SELECT:return e.getEnabled()?true:false;case _._SWITCH:return true}return false},_manageMandatoryForControl:function(e,t){if(t===_._TEXTAREA||t===_._INPUT){e.attachLiveChange(this.onLiveChangeInput.bind(this))}else if(t===_._RATINGINDICATOR){this._oWizard.setShowNextButton(true)}},_generateNewRadioButtonGroup:function(e,t){return new f({buttons:e,selectedIndex:t})},_generateNewVBox:function(e){return new c({items:e})},_generateNewWizardStep:function(e,t){return new p({content:[e],title:t,complete:this.onCompleteStepInWizard.bind(this)})},_generateNewCheckBoxControl:function(e,t,s){return r.generateNewControl(_._CHECKBOX,{text:e,editable:s,selected:t,fieldGroupIds:s?"fieldGroupSurvey":""},undefined,undefined,false)},_generateNewRadioButtonControl:function(e,t,s){return r.generateNewControl(_._RADIOBUTTON,{text:e,editable:s,selected:t,fieldGroupIds:s?"fieldGroupSurvey":""},undefined,undefined,false)},_generateNewSelectControl:function(e,t){return r.generateNewControl(_._SELECT,{selectedKey:e,editable:true,items:t,fieldGroupIds:"fieldGroupSurvey"},undefined,undefined,false)},_generateNewSelectForFinishedSurvey:function(e,t){return r.generateNewControl(_._SELECT,{selectedKey:e,editable:false,items:t},undefined,undefined,false)},_addCustomDataForControl:function(e,t,s){e.addCustomData(new l({key:s,value:t}))},_navToWorkList:function(){this.getRouter().navTo("worklist",{},true)}})});