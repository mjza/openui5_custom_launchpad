sap.ui.define(["../conf/env","sap/m/MessageToast"],function(e,n){"use strict";var t=null,r=jQuery.sap.storage(jQuery.sap.storage.Type.session),i=jQuery.sap.storage(jQuery.sap.storage.Type.local),o=function(n,r,i,o,s){var u=t;sap.ui.core.BusyIndicator.show(1e3);jQuery.ajax({type:n,contentType:"application/json; charset=utf-8",pathInfo:null,data:n==="POST"?JSON.stringify(i):i,url:e.serverUrl+r,headers:{Authorization:u},cache:false,dataType:"json",async:false,success:function(e,n,t){sap.ui.core.BusyIndicator.hide();if(typeof o==="function"){o(e,n,t)}},error:function(e,n,t){sap.ui.core.BusyIndicator.hide();if(typeof s==="function"){s(e,n,t)}}})},s=function(e,n,t,r){o("POST",e,n,t,r)},u=function(e,n,t,r){o("GET",e,n,t,r)},a=function(){var e=r.get("CurrentToken");return e!==null?JSON.parse(e):null};i.put("JwtUserEndpoint",e.userEndpoint);i.put("JwtServerUrl",e.serverUrl);var f={getJwt:function(){return t},hasSession:function(e){var n=a();if(n!==null&&n.expireAt>(new Date).getTime()){t=n.tokenType+n.accessToken;if(typeof e==="function"){e(true)}return true}else{r.clear();t=null;if(typeof e==="function"){e(false)}return false}},getExpiryTime:function(){var e=0;var n=a();if(n!==null&&n.expireAt>(new Date).getTime()){e=n.expireAt}else{r.clear();t=null}return e},getCurrentUser:function(){var e=null;if(this.hasSession()){var n=r.get("CurrentUser");if(n===null){u(i.get("JwtUserEndpoint"),null,function(n,t,i){r.put("CurrentUser",JSON.stringify(n));e=n})}else{e=JSON.parse(n)}}return e},refreshToken:function(n,i){if(this.hasSession()){var o=a();var u={refreshToken:o.refreshToken};var f=false;s(e.refreshEndpoint,u,function(e,i,s){var u={accessToken:e.accessToken,refreshToken:e.refreshToken,tokenType:e.tokenType,expireAt:(new Date).getTime()+e.expiryDuration};r.put("CurrentToken",JSON.stringify(u));t=o.tokenType+o.accessToken;if(typeof n==="function"){n(e,i,s)}f=true;sap.ui.getCore().getEventBus().publish("JWT","jwtChanged",null)},function(e,n,t){if(typeof i==="function"){i(e,n,t)}});return f}else{if(typeof i==="function"){i()}return false}},register:function(n,t,r,i,o,u){var a={firstName:n,lastName:t,username:r,email:r,password:i,registerAsAdmin:false};s(e.registerEndPoint,a,o,u)},signIn:function(n,i,o,u){var a={email:n,password:i,deviceInfo:e.deviceInfo};s(e.loginEndpoint,a,function(e,n,t){var i={accessToken:e.accessToken,refreshToken:e.refreshToken,tokenType:e.tokenType,expireAt:(new Date).getTime()+e.expiryDuration};r.put("CurrentToken",JSON.stringify(i));if(typeof o==="function"){o(e,n,t)}sap.ui.getCore().getEventBus().publish("JWT","jwtChanged",null)},function(e,n,i){r.clear();t=null;if(typeof u==="function"){u(e,n,i)}sap.ui.getCore().getEventBus().publish("JWT","jwtChanged",null)})},signOut:function(n,i){if(this.hasSession()){var o={deviceInfo:e.deviceInfo};s(e.logoutEndpoint,o,function(e,i,o){r.clear();t=null;if(typeof n==="function"){n(e,i,o)}sap.ui.getCore().getEventBus().publish("JWT","jwtChanged",null)},function(e,n,o){r.clear();t=null;if(typeof i==="function"){i(e,n,o)}sap.ui.getCore().getEventBus().publish("JWT","jwtChanged",null)})}},forgetPassword:function(n,t,r){var i={email:n};s(e.forgetEndpoint,i,t,r)},resetPassword:function(n,t,r,i,o){var u={password:n,confirmPassword:t,token:r};var a=false;s(e.resetEndpoint,u,function(e,n,t){if(typeof i==="function"){i(e,n,t)}a=true},o);return a},confirmEmail:function(n,t,r){var i="token="+n;u(e.confirmEndpoint,i,t,r)},checkEmailInUse:function(n,t,r){var i="email="+n;u(e.emailInUseEndpoint,i,t,r)},updatePassword:function(n,t,r,i){if(this.hasSession()){var o={newPassword:t,oldPassword:n};var u=false;s(e.passwordUpdateEndpoint,o,function(e,n,t){if(typeof r==="function"){r(e,n,t)}u=true},i);return u}else{if(typeof i==="function"){i()}return false}}};return f});